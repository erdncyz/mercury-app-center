<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mercury App Center</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" href="mercury-icon.png" type="image/png">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#6366f1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Mercury">
    <link rel="apple-touch-icon" href="mercury-icon.png">
    <script>
        // Dark mode flash prevention - runs immediately before page renders
        (function() {
            const saved = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const shouldUseDark = saved === 'dark' || (saved !== 'light' && prefersDark);
            
            if (shouldUseDark) {
                document.documentElement.setAttribute('data-theme', 'dark');
                document.body.setAttribute('data-theme', 'dark');
                // Update theme color for dark mode
                document.querySelector('meta[name="theme-color"]').setAttribute('content', '#181a1b');
            } else {
                // Update theme color for light mode
                document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff');
            }
        })();
    </script>
    <style>
        .api-keys-section {
            margin-top: 20px;
            overflow-x: auto;
        }

        #apiKeysList {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        #apiKeysList th,
        #apiKeysList td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        #apiKeysList th {
            background-color: #f9fafb;
            font-weight: 600;
        }

        #apiKeysList tr {
            cursor: pointer;
        }

        #apiKeysList tr:hover {
            background-color: #f3f4f6;
        }

        .generate-key-btn {
            background-color: #6366f1;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 500;
        }

        .generate-key-btn:hover {
            background-color: #4f46e5;
        }

        .api-key-row {
            font-family: monospace;
            padding: 8px;
            background-color: #f8fafc;
            border-radius: 4px;
            margin-top: 8px;
        }

        .copy-btn {
            padding: 4px 8px;
            background-color: #e5e7eb;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 8px;
        }

        .copy-btn:hover {
            background-color: #d1d5db;
        }

        .admin-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 10px;
        }

        .tab-btn {
            padding: 8px 16px;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 500;
            color: #6b7280;
        }

        .tab-btn.active {
            color: #6366f1;
            border-bottom: 2px solid #6366f1;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .api-key-row {
            background-color: #f8fafc;
            cursor: default;
        }

        .api-key-row:hover {
            background-color: #f8fafc !important;
        }

        .api-key-display {
            padding: 12px;
            margin: 8px 0;
            background-color: #eef2ff;
            border-radius: 6px;
            font-family: monospace;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .api-key-value {
            flex: 1;
            font-size: 14px;
            color: #4f46e5;
            letter-spacing: 0.5px;
            background: transparent;
            border: none;
            padding: 4px 8px;
            width: 100%;
            font-family: monospace;
        }

        .api-key-value:focus {
            outline: 1px solid #818cf8;
            background-color: white;
            border-radius: 4px;
        }

        .api-key-actions {
            display: flex;
            gap: 8px;
        }

        .copy-btn svg {
            margin-right: 4px;
            vertical-align: middle;
        }

        #apiKeysList tr {
            transition: background-color 0.2s ease;
        }

        #apiKeysList tr:hover {
            background-color: #f3f4f6;
        }

        .badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge.success {
            background-color: #dcfce7;
            color: #15803d;
        }

        .badge.error {
            background-color: #fee2e2;
            color: #b91c1c;
        }

        .copy-btn, .delete-btn {
            padding: 4px 12px;
            border-radius: 4px;
            border: none;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .copy-btn {
            background-color: #e0e7ff;
            color: #4f46e5;
            margin-right: 8px;
        }

        .copy-btn:hover {
            background-color: #c7d2fe;
        }

        .delete-btn {
            background-color: #fee2e2;
            color: #dc2626;
            padding: 6px 12px;
            border-radius: 4px;
            border: none;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .delete-btn:hover {
            background-color: #fecaca;
        }

        .delete-btn svg {
            width: 14px;
            height: 14px;
        }

        .actions-cell {
            width: 60px;
            text-align: center;
        }

        .delete-btn-small {
            background-color: transparent;
            color: #dc2626;
            padding: 4px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .delete-btn-small:hover {
            background-color: #fee2e2;
        }

        .delete-btn-small svg {
            width: 16px;
            height: 16px;
        }

        .api-key-display {
            padding: 12px;
            margin: 8px 0;
            background-color: #eef2ff;
            border-radius: 6px;
            font-family: monospace;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .api-key-value {
            flex: 1;
            font-size: 14px;
            color: #4f46e5;
            letter-spacing: 0.5px;
            background: transparent;
            border: none;
            padding: 4px 8px;
            width: 100%;
            font-family: monospace;
        }

        .api-key-value:focus {
            outline: 1px solid #818cf8;
            background-color: white;
            border-radius: 4px;
        }

        .api-key-actions {
            display: flex;
            gap: 8px;
        }

        .copy-btn {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background-color: #e0e7ff;
            color: #4f46e5;
            padding: 6px 12px;
            border-radius: 4px;
            border: none;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .copy-btn:hover {
            background-color: #c7d2fe;
        }

        .copy-btn svg {
            width: 14px;
            height: 14px;
        }
    </style>
</head>
<body>
    <div id="loginContainer">
        <div class="login-theme-toggle">
            <button id="loginDarkModeToggle" title="Toggle dark mode">üåô</button>
        </div>
        <div class="login-box">
            <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%236366f1'%3E%3Cpath d='M12 2c-4.4 0-8 3.6-8 8s3.6 8 8 8 8-3.6 8-8-3.6-8-8-8zm0 14c-3.3 0-6-2.7-6-6s2.7-6 6-6 6 2.7 6 6-2.7 6-6 6z'/%3E%3Ccircle cx='12' cy='8' r='2'/%3E%3Crect x='11' y='10' width='2' height='6'/%3E%3Crect x='11' y='16' width='2' height='2'/%3E%3C/svg%3E" alt="Mercury Icon" class="login-icon">
            <h2>Mercury App Center</h2>
            <div class="auth-toggle">
                <button class="auth-toggle-btn active" data-target="loginForm">Login</button>
                <button class="auth-toggle-btn" data-target="registerForm">Register</button>
            </div>
            <form id="loginForm" onsubmit="handleLogin(event)">
                <input type="text" id="usernameOrEmail" placeholder="Username or Email" required>
                <input type="password" id="password" placeholder="Password" required>
                <button type="submit">Login</button>
                <div class="forgot-password-link">
                    <a href="#" onclick="showForgotPasswordForm()">Forgot Password?</a>
                </div>
            </form>
            <form id="forgotPasswordForm" style="display: none;" onsubmit="handleForgotPassword(event)">
                <input type="email" id="forgotPasswordEmail" placeholder="Enter your email" required>
                <button type="submit">Send Reset Link</button>
                <div id="forgotPasswordError" class="login-error"></div>
                <div class="back-to-login">
                    <a href="#" onclick="showLoginForm()">Back to Login</a>
                </div>
            </form>
            <form id="resetPasswordForm" style="display: none;" onsubmit="handleResetPassword(event)">
                <input type="password" id="newPassword" placeholder="New Password" required>
                <input type="password" id="confirmPassword" placeholder="Confirm Password" required>
                <button type="submit">Reset Password</button>
            </form>
            <form id="registerForm" style="display: none;" onsubmit="handleRegister(event)">
                <input type="text" id="registerUsername" placeholder="Username" required>
                <input type="password" id="registerPassword" placeholder="Password" required>
                <input type="email" id="registerEmail" placeholder="Email">
                <input type="text" id="registerFullName" placeholder="Full Name">
                <button type="submit">Register</button>
                <div id="registerError" class="login-error"></div>
            </form>
        </div>
        <div class="background-icons"></div>
    </div>

    <div id="mainContainer" style="display: none;">
        <header>
            <div class="header-left">
                <img src="mercury-icon.png" alt="Mercury Icon" class="header-icon">
                <h1>Mercury App Center</h1>
            </div>
            <div class="header-right">
                <span id="userDisplay"></span>
                <button id="darkModeToggle" title="Toggle dark mode" style="margin-right: 0.5rem;">üåô</button>
                <button id="adminPanelButton" style="display: none;" onclick="showAdminPanel()">Admin Panel</button>
                <button onclick="handleLogout()">Logout</button>
            </div>
        </header>

        <main>
            <div class="search-bar">
                <input type="text" id="searchInput" placeholder="Search apps..." oninput="filterUploads()">
                <select id="osFilter" onchange="filterUploads()">
                    <option value="all">All OS</option>
                    <option value="ios">iOS</option>
                    <option value="android">Android</option>
                    <option value="tvos">Apple TV</option>
                    <option value="androidtv">Android TV</option>
                    <option value="huawei">Huawei</option>
                </select>
            </div>

            <div class="create-project">
                <button onclick="showCreateProjectModal()">Create New Project</button>
            </div>

            <div id="allApps"></div>

            <div id="createProjectModal" class="modal">
                <div class="modal-content">
                    <div class="modal-close" onclick="closeModal('createProjectModal')"></div>
                    <h2>Create New Project</h2>
                    <form id="createProjectForm">
                        <div class="form-group">
                            <label>Project Name</label>
                            <input type="text" id="projectNameInput" required>
                        </div>
                        <div class="modal-actions">
                            <button type="button" class="cancel-btn" onclick="closeModal('createProjectModal')">Cancel</button>
                            <button type="submit" class="create-btn">Create</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Large File Warning Modal -->
            <div id="largeFileModal" class="modal">
                <div class="modal-content">
                    <div class="modal-close" onclick="closeLargeFileModal()"></div>
                    <div class="upload-modal-header">
                        <div class="warning-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 2L2 19H22L12 2Z" stroke="#F59E0B" stroke-width="2" fill="none"/>
                                <path d="M12 9V13" stroke="#F59E0B" stroke-width="2" stroke-linecap="round"/>
                                <circle cx="12" cy="16" r="1" fill="#F59E0B"/>
                            </svg>
                        </div>
                        <h2>Large File Detected</h2>
                    </div>
                    <div class="large-file-content">
                        <p class="file-size-info">
                            <span id="largeFileSize" class="file-size"></span> file detected.
                        </p>
                        <p class="file-description">
                            This file will be automatically split into smaller parts for reliable upload. 
                            Your file will remain intact and functional.
                        </p>
                        <div class="benefits-list">
                            <div class="benefit-item">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M20 6L9 17L4 12" stroke="#10B981" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                <span>File integrity guaranteed</span>
                            </div>
                            <div class="benefit-item">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M20 6L9 17L4 12" stroke="#10B981" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                <span>Automatic splitting and upload</span>
                            </div>
                            <div class="benefit-item">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M20 6L9 17L4 12" stroke="#10B981" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                <span>Progress tracking available</span>
                            </div>
                        </div>
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="cancel-btn" onclick="closeLargeFileModal()">Cancel</button>
                        <button type="button" class="create-btn" onclick="continueLargeFileUpload()">Continue Upload</button>
                    </div>
                </div>
            </div>

            <div id="uploadModal" class="modal">
                <div class="modal-content">
                    <div class="modal-close" onclick="closeModal('uploadModal')"></div>
                    <div class="upload-modal-header">
                        <h2>Upload New Version</h2>
                        <div style="display: flex; flex-direction: column; gap: 1.2rem; margin-bottom: 1.5rem;">
                            <div class="form-group project-row" style="display: flex; align-items: center; gap: 1rem; margin: 0;">
                                <label for="uploadProjectName" style="font-weight: bold; margin: 0; min-width: 120px;">Selected Project:</label>
                                <span id="uploadProjectName" style="flex:1; min-width: 200px; max-width: 350px;"></span>
                            </div>
                            <div class="form-group platform-row" id="platformSelectGroup" style="display: flex; align-items: center; gap: 1rem; margin: 0;">
                                <label for="platformSelect" style="font-weight: bold; margin: 0; min-width: 120px;">Select Platform:</label>
                                <select id="platformSelect" name="platform" required style="flex:1; min-width: 200px; max-width: 350px;">
                                    <option value="">Please select a platform</option>
                                    <option value="ios">iOS</option>
                                    <option value="android">Android</option>
                                    <option value="tvos">Apple TV</option>
                                    <option value="androidtv">Android TV</option>
                                    <option value="huawei">Huawei</option>
                                    <option value="onvotv">Onvo TV</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <form id="uploadForm">
                        <input type="hidden" id="projectIdInput" name="projectId">
                        
                        <!-- Standard fields (hidden for iOS/tvOS) -->
                        <div id="standardFieldsGroup">
                            <div class="form-group">
                                <label>Version</label>
                                <input type="text" id="versionInput" name="version" required placeholder="1.0.0">
                            </div>
                            <div class="form-group">
                                <label>Build Number (Optional)</label>
                                <input type="text" id="buildNumberInput" name="buildNumber" placeholder="123">
                            </div>
                            <div class="form-group">
                                <label>Test Notes</label>
                                <textarea id="testNotes" name="notes" rows="4"></textarea>
                            </div>
                            <div class="form-group">
                                <label>Environment</label>
                                <select id="environmentSelect" name="environment" required>
                                    <option value="production">Production (Market)</option>
                                    <option value="test">Test</option>
                                    <option value="regression">Regression</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- URL only fields (shown for iOS/tvOS) -->
                        <div id="urlOnlyFieldsGroup" style="display:none;">
                            <div class="url-explanation">
                                <p>For iOS and Apple TV platforms, please enter a direct TestFlight, AppStore or a test distribution service link.</p>
                                <p>You can use a public test link from TestFlight, AppStore Connect, or third-party distribution services (Firebase App Distribution, AppCenter, etc.).</p>
                            </div>
                        </div>
                        
                        <div class="form-group" id="appFileGroup">
                            <label>App File</label>
                            <div id="jiraUploadArea" class="jira-upload-area" onclick="document.getElementById('appFile').click();" ondragover="event.preventDefault(); this.classList.add('dragover');" ondragleave="this.classList.remove('dragover');" ondrop="handleJiraDrop(event)">
                                <span id="jiraUploadText">Drag and drop a file here or <span class="jira-browse-link">Browse</span></span>
                                <input type="file" id="appFile" name="file" accept=".apk,.aab,.ipa,.zip" style="display:none" onchange="handleJiraFileChange(event)">
                            </div>
                            <div id="jiraFileInfo" class="jira-file-info" style="display:none;"></div>
                            <div class="file-info">Accepted formats: APK, AAB, IPA, ZIP</div>
                        </div>
                        <div class="form-group" id="appUrlGroup" style="display:none;">
                            <label>Public Test URL</label>
                            <input type="url" id="appUrl" name="url" placeholder="https://test-flight.example.com/your-app">
                        </div>
                        <div class="modal-actions">
                            <button type="button" class="cancel-btn" onclick="closeModal('uploadModal')">Cancel</button>
                            <button type="submit" class="create-btn">Upload</button>
                        </div>
                    </form>
                </div>
            </div>

            <div id="usersAdminModal" class="modal">
                <div class="modal-content">
                    <div class="modal-close" onclick="closeModal('usersAdminModal')"></div>
                    <div class="admin-tabs">
                        <button class="tab-btn active" onclick="showTab('userManagement')">User Management</button>
                        <button class="tab-btn" onclick="showTab('apiKeyManagement')">API Keys</button>
                    </div>
                    <div id="userManagement" class="tab-content active">
                        <h2>User Management</h2>
                        <p>Approve or reject pending user registrations</p>
                        <div id="usersList"></div>
                    </div>
                    <div id="apiKeyManagement" class="tab-content">
                        <h2>API Key Management</h2>
                        <button class="generate-key-btn" onclick="generateApiKey()">Generate New API Key</button>
                        <div class="api-keys-section">
                            <table id="apiKeysList">
                                <thead>
                                    <tr>
                                        <th>Description</th>
                                        <th>Created</th>
                                        <th>Last Used</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="cancel-btn" onclick="closeModal('usersAdminModal')">Close</button>
                    </div>
                </div>
            </div>

            <div id="apiKeyDialog" class="modal">
                <div class="modal-content">
                    <div class="modal-close" onclick="closeApiKeyDialog()"></div>
                    <h2>Generate API Key</h2>
                    <form id="apiKeyForm" onsubmit="handleApiKeyGeneration(event)">
                        <div class="form-group">
                            <label>Description</label>
                            <input type="text" id="apiKeyDescription" required placeholder="e.g., Jenkins Pipeline Key">
                        </div>
                        <div class="modal-actions">
                            <button type="button" class="cancel-btn" onclick="closeApiKeyDialog()">Cancel</button>
                            <button type="submit" class="create-btn">Generate</button>
                        </div>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <!-- Manage Projects Modal -->
    <div id="manageProjectsModal" class="modal">
        <div class="modal-content">
            <div class="modal-close" onclick="closeManageProjectsModal()"></div>
            <h2 id="manageProjectsTitle">Manage Projects</h2>
            <div id="projectSelectionList" class="project-selection-container">
                <!-- Project checkboxes will be loaded here -->
                <p>Loading projects...</p>
            </div>
            <div class="modal-actions">
                <button type="button" class="cancel-btn" onclick="closeManageProjectsModal()">Cancel</button>
                <button type="button" class="create-btn" onclick="saveUserProjects()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notification-container" aria-live="assertive" aria-atomic="true"></div>

    <!-- PWA Install Instructions Modal -->
    <div id="pwaInstructionsModal" class="modal">
        <div class="modal-content pwa-instructions-modal">
            <h2>üì± Install Mercury App Center on Your Device</h2>
            <p>For a better experience, you can install the app on your device:</p>
            
            <div class="instruction-tabs">
                <button class="instruction-tab active" data-tab="ios">üçé iOS</button>
                <button class="instruction-tab" data-tab="android">ü§ñ Android</button>
                <button class="instruction-tab" data-tab="desktop">üíª Desktop</button>
            </div>

            <div class="instruction-content">
                <div id="ios-instructions" class="instruction-panel active">
                    <div class="instruction-steps">
                        <div class="step">
                            <div class="step-number">1</div>
                            <div class="step-text">Tap the <strong>Share</strong> button in Safari</div>
                            <div class="step-icon">üì§</div>
                        </div>
                        <div class="step">
                            <div class="step-number">2</div>
                            <div class="step-text">Find <strong>"Add to Home Screen"</strong> option</div>
                            <div class="step-icon">‚ûï</div>
                        </div>
                        <div class="step">
                            <div class="step-number">3</div>
                            <div class="step-text">Tap <strong>"Add"</strong> button</div>
                            <div class="step-icon">‚úÖ</div>
                        </div>
                    </div>
                </div>

                <div id="android-instructions" class="instruction-panel">
                    <div class="instruction-steps">
                        <div class="step">
                            <div class="step-number">1</div>
                            <div class="step-text">Tap the <strong>menu</strong> button in Chrome (‚ãÆ)</div>
                            <div class="step-icon">‚ãÆ</div>
                        </div>
                        <div class="step">
                            <div class="step-number">2</div>
                            <div class="step-text">Select <strong>"Add to Home screen"</strong> option</div>
                            <div class="step-icon">üì≤</div>
                        </div>
                        <div class="step">
                            <div class="step-number">3</div>
                            <div class="step-text">Tap <strong>"Install"</strong> button</div>
                            <div class="step-icon">‚¨áÔ∏è</div>
                        </div>
                    </div>
                </div>

                <div id="desktop-instructions" class="instruction-panel">
                    <div class="instruction-steps">
                        <div class="step">
                            <div class="step-number">1</div>
                            <div class="step-text">Click the <strong>install icon</strong> in the address bar</div>
                            <div class="step-icon">‚¨áÔ∏è</div>
                        </div>
                        <div class="step">
                            <div class="step-number">2</div>
                            <div class="step-text">Or use the <strong>"Install App"</strong> button in the bottom right</div>
                            <div class="step-icon">üîΩ</div>
                        </div>
                        <div class="step">
                            <div class="step-number">3</div>
                            <div class="step-text">Click <strong>"Install"</strong> button</div>
                            <div class="step-icon">‚úÖ</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pwa-benefits">
                <h3>‚ú® Benefits:</h3>
                <ul>
                    <li>üöÄ Faster loading</li>
                    <li>üì± Full screen experience</li>
                    <li>üîî Push notifications</li>
                    <li>üì∂ Offline usage</li>
                </ul>
            </div>

            <div class="modal-actions">
                <button class="cancel-btn" onclick="closePWAInstructions()">Not Now</button>
                <button class="create-btn" onclick="closePWAInstructions(true)">Got It</button>
            </div>
        </div>
    </div>

    <script>
        const CONFIG = {
            baseUrl: `http://${location.hostname}:${location.port || 80}`
        };

        // Global variables
        let currentEditingUserId = null; // Moved declaration here
        let pendingUploadData = null; // For large file upload modal
        let currentPage = 1;
        const itemsPerPage = 10;
        let allVersions = [];
        let filteredVersions = [];
        
        // Enhance touch interactions for mobile
        function enhanceTouchExperience() {
            const isMobile = window.matchMedia('(max-width: 768px)').matches;
            
            if (isMobile) {
                // Add touch delay to prevent accidental taps
                document.querySelectorAll('button, .app-card, .version-item').forEach(element => {
                    element.addEventListener('touchstart', function() {
                        this.classList.add('touch-active');
                    });
                    
                    element.addEventListener('touchend', function() {
                        this.classList.remove('touch-active');
                    });
                    
                    element.addEventListener('touchcancel', function() {
                        this.classList.remove('touch-active');
                    });
                });
                
                // Add better scrolling for modals on mobile
                document.querySelectorAll('.modal-content').forEach(modal => {
                    modal.addEventListener('touchmove', function(e) {
                        e.stopPropagation();
                    });
                });
            }
        }

        // PWA Instructions Modal Functions
        function showPWAInstructions() {
            const modal = document.getElementById('pwaInstructionsModal');
            modal.style.display = 'flex';
            
            // Setup tab switching
            document.querySelectorAll('.instruction-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    // Remove active class from all tabs and panels
                    document.querySelectorAll('.instruction-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.instruction-panel').forEach(p => p.classList.remove('active'));
                    
                    // Add active class to clicked tab
                    this.classList.add('active');
                    
                    // Show corresponding panel
                    const targetPanel = document.getElementById(this.dataset.tab + '-instructions');
                    if (targetPanel) {
                        targetPanel.classList.add('active');
                    }
                });
            });
        }
        
        function closePWAInstructions(understood = false) {
            const modal = document.getElementById('pwaInstructionsModal');
            modal.style.display = 'none';
            
            if (understood) {
                // Mark as shown so it doesn't appear again
                localStorage.setItem('pwaInstructionsShown', 'true');
            }
        }
        
        function checkAndShowPWAInstructions() {
            // Only show if not already shown and not in standalone mode (already installed)
            const alreadyShown = localStorage.getItem('pwaInstructionsShown');
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches;
            const isIOSStandalone = window.navigator.standalone;
            
            console.log('PWA Instructions Check:', {
                alreadyShown,
                isStandalone,
                isIOSStandalone
            });
            
            if (!alreadyShown && !isStandalone && !isIOSStandalone) {
                // Show after a short delay to let the page load
                console.log('Showing PWA instructions...');
                setTimeout(() => {
                    showPWAInstructions();
                }, 2000);
            } else {
                console.log('PWA instructions not shown because:', {
                    alreadyShown: !!alreadyShown,
                    isStandalone,
                    isIOSStandalone
                });
            }
        }

        // When document is ready
        document.addEventListener('DOMContentLoaded', async function() {
            // Set auth toggle event listeners
            document.querySelectorAll('.auth-toggle-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const targetForm = this.dataset.target;
                    
                    // Hide all forms
                    document.getElementById('loginForm').style.display = 'none';
                    document.getElementById('registerForm').style.display = 'none';
                    
                    // Show selected form
                    document.getElementById(targetForm).style.display = 'block';
                    
                    // Update active states
                    document.querySelectorAll('.auth-toggle-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    this.classList.add('active');
                });
            });
            
            // Platform se√ßimini dinle
            document.getElementById('platformSelect').addEventListener('change', toggleFileOrUrlInput);
            
            if (localStorage.getItem('isLoggedIn') === 'true') {
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('mainContainer').style.display = 'block';
                updateUsername();
                showAllApps();
                // Check if we should show PWA instructions
                checkAndShowPWAInstructions();
            }
            
            await checkLoginStatus();
            setupModalBackgroundClose();
            
            // Always check for PWA instructions on page load (whether logged in or not)
            checkAndShowPWAInstructions();
            
            // Dark mode toggle logic
            const darkModeToggle = document.getElementById('darkModeToggle');
            const loginDarkModeToggle = document.getElementById('loginDarkModeToggle');
            
            function setTheme(theme) {
                document.body.setAttribute('data-theme', theme);
                document.documentElement.setAttribute('data-theme', theme);
                localStorage.setItem('theme', theme);
                
                // Update both toggle buttons if they exist
                if (darkModeToggle) {
                    darkModeToggle.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
                }
                if (loginDarkModeToggle) {
                    loginDarkModeToggle.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
                }
                
                // Update theme-color meta tag for PWA status bar
                const themeColorMeta = document.querySelector('meta[name="theme-color"]');
                if (themeColorMeta) {
                    themeColorMeta.setAttribute('content', theme === 'dark' ? '#181a1b' : '#ffffff');
                }
            }
            
            // Main app dark mode toggle
            if (darkModeToggle) {
                darkModeToggle.onclick = function() {
                    const current = document.body.getAttribute('data-theme') === 'dark' ? 'dark' : 'light';
                    setTheme(current === 'dark' ? 'light' : 'dark');
                };
            }
            
            // Login page dark mode toggle
            if (loginDarkModeToggle) {
                loginDarkModeToggle.onclick = function() {
                    const current = document.body.getAttribute('data-theme') === 'dark' ? 'dark' : 'light';
                    setTheme(current === 'dark' ? 'light' : 'dark');
                };
            }
            (function() {
                const saved = localStorage.getItem('theme');
                if (saved === 'dark' || (saved !== 'light' && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                    setTheme('dark');
                } else {
                    setTheme('light');
                }
            })();
        });
        
        // Update enhanceTouchExperience on resize
        window.addEventListener('resize', function() {
            enhanceTouchExperience();
        });
        
        // Prevent zooming on double-tap for iOS Safari
        document.addEventListener('touchstart', function(event) {
            if (event.touches.length > 1) {
                event.preventDefault();
            }
        }, { passive: false });
        
        // Code to initialize touch active style
        document.head.insertAdjacentHTML('beforeend', `
            <style>
                .touch-active {
                    opacity: 0.7;
                    transition: opacity 0.2s;
                }
            </style>
        `);

        async function handleLogin(event) {
            event.preventDefault();
            removeLoginError();
            
            const username = document.getElementById('usernameOrEmail').value;
            const password = document.getElementById('password').value;

            try {
                const response = await fetch(`${CONFIG.baseUrl}/login`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();
                if (data.success) {
                    localStorage.setItem('isLoggedIn', 'true');
                    localStorage.setItem('username', data.user.username);
                    localStorage.setItem('userRole', data.user.role);
                    document.getElementById('loginContainer').style.display = 'none';
                    document.getElementById('mainContainer').style.display = 'block';
                    updateUsername();
                    await checkAdminStatus();
                    await updateUserPermissions();
                    showAllApps();
                    // Check if we should show PWA instructions after login
                    checkAndShowPWAInstructions();
                } else {
                    showLoginError(data.message || data.error || 'Invalid username or password');
                }
            } catch (error) {
                console.error('Login error:', error);
                showLoginError('Login failed. Please try again.');
            }
        }

        function showLoginError(message) {
            // √ñnce varolan hata mesajƒ±nƒ± temizle
            removeLoginError();
            
            const loginForm = document.getElementById('loginForm');
            const submitButton = loginForm.querySelector('button[type="submit"]');
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'login-error';
            
            const errorIcon = document.createElement('div');
            errorIcon.className = 'login-error-icon';
            errorIcon.innerHTML = `
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                          d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
            `;
            
            const errorMessage = document.createElement('span');
            errorMessage.textContent = message;
            
            errorDiv.appendChild(errorIcon);
            errorDiv.appendChild(errorMessage);
            
            // Hata mesajƒ±nƒ± login butonundan √∂nce ekle
            loginForm.insertBefore(errorDiv, submitButton);
        }

        function removeLoginError() {
            // Sadece login formundaki login-error'u sil
            const loginForm = document.getElementById('loginForm');
            if (!loginForm) return;
            const loginError = loginForm.querySelector('.login-error');
            if (loginError) loginError.remove();
        }

        async function handleLogout() {
            try {
                const response = await fetch(`${CONFIG.baseUrl}/logout`, {
                    method: 'POST',
                    credentials: 'include'
                });

                const data = await response.json();
                if (data.success) {
                    localStorage.removeItem('isLoggedIn');
                    localStorage.removeItem('username');
                    localStorage.removeItem('userRole');
                    document.getElementById('loginContainer').style.display = 'block';
                    document.getElementById('mainContainer').style.display = 'none';
                    showNotification('Logged out successfully', 'success');
                }
            } catch (error) {
                console.error('Logout error:', error);
                showNotification('Logout failed', 'error');
            }
        }

        function updateUsername() {
            const username = localStorage.getItem('username');
            if (username) {
                document.getElementById('userDisplay').textContent = `Welcome, ${username}`;
            }
        }

        async function checkLoginStatus() {
            try {
                const response = await fetch(`${CONFIG.baseUrl}/api/check-session`, {
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (data.isLoggedIn) {
                    localStorage.setItem('isLoggedIn', 'true');
                    localStorage.setItem('username', data.username);
                    localStorage.setItem('userRole', data.userRole);
                    document.getElementById('loginContainer').style.display = 'none';
                    document.getElementById('mainContainer').style.display = 'block';
                    updateUsername();
                    await checkAdminStatus();
                    await updateUserPermissions();
                    // Check if we should show PWA instructions after session check
                    checkAndShowPWAInstructions();
                } else {
                    localStorage.removeItem('isLoggedIn');
                    localStorage.removeItem('username');
                    localStorage.removeItem('userRole');
                    document.getElementById('loginContainer').style.display = 'block';
                    document.getElementById('mainContainer').style.display = 'none';
                }
            } catch (error) {
                console.error('Login status check error:', error);
                document.getElementById('loginContainer').style.display = 'block';
                document.getElementById('mainContainer').style.display = 'none';
            }
        }

        function showCreateProjectModal() {
            const modal = document.getElementById('createProjectModal');
            modal.style.display = 'flex';
            document.getElementById('createProjectForm').reset();
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.style.display = 'none';
        }

        document.getElementById('createProjectForm').addEventListener('submit', async (event) => {
            event.preventDefault();
            
            const projectName = document.getElementById('projectNameInput').value;
            
            try {
                const response = await fetch(`${CONFIG.baseUrl}/api/projects`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name: projectName })
                });

                const data = await response.json();
                if (data.success) {
                    showNotification('Project created successfully', 'success');
                    closeModal('createProjectModal');
                    showAllApps();
                } else {
                    showNotification(data.error || 'Failed to create project', 'error');
                }
            } catch (error) {
                console.error('Project creation error:', error);
                showNotification('Failed to create project', 'error');
            }
        });

        async function showAllApps(page = 1) {
            try {
                const response = await fetch(`${CONFIG.baseUrl}/api/projects?page=${page}&limit=10`, {
                    credentials: 'include'
                });
                const data = await response.json();
                
                const container = document.getElementById('allApps');
                
                if (page === 1) {
                    container.innerHTML = '';
                }

                data.projects.forEach(project => {
                    const card = document.createElement('div');
                    card.className = 'app-card';
                    card.setAttribute('onclick', 'toggleProject(event, this)');
                    
                    // Make versions unique
                    const uniqueVersions = project.versions ? project.versions.reduce((acc, current) => {
                        const x = acc.find(item => item.version === current.version && item.platform === current.platform);
                        if (!x) {
                            return acc.concat([current]);
                        } else {
                            // If the same version exists, use the newer one
                            if (new Date(current.uploadedAt) > new Date(x.uploadedAt)) {
                                const index = acc.indexOf(x);
                                acc[index] = current;
                            }
                            return acc;
                        }
                    }, []) : [];

                    // Sort versions by date (newest first)
                    uniqueVersions.sort((a, b) => new Date(b.uploadedAt) - new Date(a.uploadedAt));

                    const platforms = {
                        ios: uniqueVersions.filter(v => v.platform === 'ios'),
                        android: uniqueVersions.filter(v => v.platform === 'android'),
                        tvos: uniqueVersions.filter(v => v.platform === 'tvos'),
                        androidtv: uniqueVersions.filter(v => v.platform === 'androidtv'),
                        huawei: uniqueVersions.filter(v => v.platform === 'huawei'),
                        onvotv: uniqueVersions.filter(v => v.platform === 'onvotv')
                    };
                    
                    card.innerHTML = `
                        <div class="app-header">
                            <div class="app-title">${project.name}</div>
                            <div class="app-actions">
                                <button onclick="event.stopPropagation(); openUploadModal('${project.id}', '${project.name}')">
                                    <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                                    </svg>
                                    Upload New Version
                                </button>
                                <button onclick="event.stopPropagation(); deleteProject('${project.id}')">
                                    <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                    </svg>
                                    Delete
                                </button>
                            </div>
                        </div>
                        <div class="platform-container">
                            ${platforms.ios.length > 0 ? `
                                <div class="platform-item">
                                    <div class="platform-header">
                                        <span>üçé iOS</span>
                                    </div>
                                    ${platforms.ios.map(version => `
                                        <div class="version-item" onclick="toggleVersion(event, this)">
                                            <div class="version-header">
                                                <div class="version-title">
                                                    ${version.url ? `<span class="url-badge">URL</span>` : `<span class="version-number">v${version.version || 'N/A'}${version.buildNumber ? ` (${version.buildNumber})` : ''}</span>`}
                                                    <span class="version-date">${new Date(version.uploadedAt).toLocaleString()}</span>
                                                </div>
                                                <div class="version-toggle">‚ñº</div>
                                            </div>
                                            <div class="version-content">
                                                <div class="version-info">
                                                    <div class="version-uploader">Uploaded by: ${version.uploadedBy || 'Unknown'}</div>
                                                    ${version.url ? 
                                                      `<div class="version-url">Test URL: <a href="${version.url}" target="_blank">${version.url}</a></div>
                                                       
                                                       <div class="testflight-instructions">
                                                         <h4>üì± How to Test Using TestFlight:</h4>
                                                         <ol>
                                                           <li>Download the <a href="https://apps.apple.com/us/app/testflight/id899247664" target="_blank">TestFlight app</a> from the App Store</li>
                                                           <li>Open the URL above in the TestFlight app</li>
                                                           <li>Install the app and start testing</li>
                                                         </ol>
                                                       </div>` : 
                                                      `<div class="version-environment-info">
                                                         <span class="environment-label">Environment:</span>
                                                         <span class="environment-value ${version.environment || 'undefined'}">${getEnvironmentLabel(version.environment)}</span>
                                                       </div>
                                                       ${version.buildNumber ? `<div class="version-build-number">Build: ${version.buildNumber}</div>` : ''}
                                                       <div class="version-notes">${version.notes || 'No notes'}</div>`
                                                    }
                                                </div>
                                                <div class="version-actions">
                                                    <div class="modern-buttons-container">
                                                        <button class="modern-button edit-button" onclick="event.stopPropagation(); editVersion('${project.id}', '${version.id}')">
                                                            <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                                            </svg>
                                                            Edit
                                                        </button>
                                                        <button class="modern-button delete-button" onclick="event.stopPropagation(); deleteVersion('${project.id}', '${version.id}')">
                                                            <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                                            </svg>
                                                            Delete
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                            ${platforms.android.length > 0 ? `
                                <div class="platform-item">
                                    <div class="platform-header">
                                        <span>ü§ñ Android</span>
                                    </div>
                                    ${platforms.android.map(version => `
                                        <div class="version-item" onclick="toggleVersion(event, this)">
                                            <div class="version-header">
                                                <div class="version-title">
                                                    <span class="version-number">v${version.version || 'N/A'}${version.buildNumber ? ` (${version.buildNumber})` : ''}</span>
                                                    <span class="version-environment ${version.environment || 'undefined'}">${getEnvironmentLabel(version.environment)}</span>
                                                    <span class="version-date">${new Date(version.uploadedAt).toLocaleString()}</span>
                                                </div>
                                                <div class="version-toggle">‚ñº</div>
                                            </div>
                                            <div class="version-content">
                                                <div class="version-info">
                                                    <div class="version-uploader">Uploaded by: ${version.uploadedBy || 'Unknown'}</div>
                                                    <div class="version-environment-info">
                                                        <span class="environment-label">Environment:</span>
                                                        <span class="environment-value ${version.environment || 'undefined'}">${getEnvironmentLabel(version.environment)}</span>
                                                    </div>
                                                    ${version.buildNumber ? `<div class="version-build-number">Build: ${version.buildNumber}</div>` : ''}
                                                    <div class="version-notes">${version.notes || 'No notes'}</div>
                                                </div>
                                                <div class="version-actions">
                                                    <div class="modern-buttons-container">
                                                        <button class="modern-button download-button" ontouchstart="" onclick="event.stopPropagation(); downloadVersion('${project.id}', '${version.id}')">
                                                            <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                                                            </svg>
                                                            Download
                                                        </button>
                                                        <button class="modern-button delete-button" onclick="event.stopPropagation(); deleteVersion('${project.id}', '${version.id}')">
                                                            <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                                            </svg>
                                                            Delete
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                            ${platforms.tvos.length > 0 ? `
                                <div class="platform-item">
                                    <div class="platform-header">
                                        <span>üì∫ Apple TV</span>
                                    </div>
                                    ${platforms.tvos.map(version => `
                                        <div class="version-item" onclick="toggleVersion(event, this)">
                                            <div class="version-header">
                                                <div class="version-title">
                                                    ${version.url ? `<span class="url-badge">URL</span>` : `<span class="version-number">v${version.version || 'N/A'}${version.buildNumber ? ` (${version.buildNumber})` : ''}</span>`}
                                                    <span class="version-date">${new Date(version.uploadedAt).toLocaleString()}</span>
                                                </div>
                                                <div class="version-toggle">‚ñº</div>
                                            </div>
                                            <div class="version-content">
                                                <div class="version-info">
                                                    <div class="version-uploader">Uploaded by: ${version.uploadedBy || 'Unknown'}</div>
                                                    ${version.url ? 
                                                      `<div class="version-url">Test URL: <a href="${version.url}" target="_blank">${version.url}</a></div>
                                                       
                                                       <div class="testflight-instructions">
                                                         <h4>üì± TestFlight √úzerinden Test Etmek ƒ∞√ßin:</h4>
                                                         <ol>
                                                           <li>App Store'dan <a href="https://apps.apple.com/us/app/testflight/id899247664" target="_blank">TestFlight uygulamasƒ±nƒ±</a> y√ºkleyin</li>
                                                           <li>Yukarƒ±daki URL'yi TestFlight uygulamasƒ±nda a√ßƒ±n</li>
                                                           <li>Uygulamayƒ± y√ºkleyin ve test edin</li>
                                                         </ol>
                                                       </div>` : 
                                                      `<div class="version-environment-info">
                                                         <span class="environment-label">Environment:</span>
                                                         <span class="environment-value ${version.environment || 'undefined'}">${getEnvironmentLabel(version.environment)}</span>
                                                       </div>
                                                       ${version.buildNumber ? `<div class="version-build-number">Build: ${version.buildNumber}</div>` : ''}
                                                       <div class="version-notes">${version.notes || 'No notes'}</div>`
                                                    }
                                                </div>
                                                <div class="version-actions">
                                                    <div class="modern-buttons-container">
                                                        <button class="modern-button edit-button" onclick="event.stopPropagation(); editVersion('${project.id}', '${version.id}')">
                                                            <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                                            </svg>
                                                            Edit
                                                        </button>
                                                        <button class="modern-button delete-button" onclick="event.stopPropagation(); deleteVersion('${project.id}', '${version.id}')">
                                                            <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                                            </svg>
                                                            Delete
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                            ${platforms.androidtv.length > 0 ? `
                                <div class="platform-item">
                                    <div class="platform-header">
                                        <span>üì∫ Android TV</span>
                                    </div>
                                    ${platforms.androidtv.map(version => `
                                        <div class="version-item" onclick="toggleVersion(event, this)">
                                            <div class="version-header">
                                                <div class="version-title">
                                                    <span class="version-number">v${version.version || 'N/A'}${version.buildNumber ? ` (${version.buildNumber})` : ''}</span>
                                                    <span class="version-environment ${version.environment || 'undefined'}">${getEnvironmentLabel(version.environment)}</span>
                                                    <span class="version-date">${new Date(version.uploadedAt).toLocaleString()}</span>
                                                </div>
                                                <div class="version-toggle">‚ñº</div>
                                            </div>
                                            <div class="version-content">
                                                <div class="version-info">
                                                    <div class="version-uploader">Uploaded by: ${version.uploadedBy || 'Unknown'}</div>
                                                    <div class="version-environment-info">
                                                        <span class="environment-label">Environment:</span>
                                                        <span class="environment-value ${version.environment || 'undefined'}">${getEnvironmentLabel(version.environment)}</span>
                                                    </div>
                                                    ${version.buildNumber ? `<div class="version-build-number">Build: ${version.buildNumber}</div>` : ''}
                                                    <div class="version-notes">${version.notes || 'No notes'}</div>
                                                </div>
                                                <div class="version-actions">
                                                    <div class="modern-buttons-container">
                                                        <button class="modern-button download-button" ontouchstart="" onclick="event.stopPropagation(); downloadVersion('${project.id}', '${version.id}')">
                                                            <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                                                            </svg>
                                                            Download
                                                        </button>
                                                        <button class="modern-button delete-button" onclick="event.stopPropagation(); deleteVersion('${project.id}', '${version.id}')">
                                                            <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                                            </svg>
                                                            Delete
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                            ${platforms.huawei.length > 0 ? `
                                <div class="platform-item">
                                    <div class="platform-header">
                                        <span>üåê Huawei</span>
                                    </div>
                                    ${platforms.huawei.map(version => `
                                        <div class="version-item" onclick="toggleVersion(event, this)">
                                            <div class="version-header">
                                                <div class="version-title">
                                                    <span class="version-number">v${version.version || 'N/A'}${version.buildNumber ? ` (${version.buildNumber})` : ''}</span>
                                                    <span class="version-environment ${version.environment || 'undefined'}">${getEnvironmentLabel(version.environment)}</span>
                                                    <span class="version-date">${new Date(version.uploadedAt).toLocaleString()}</span>
                                                </div>
                                                <div class="version-toggle">‚ñº</div>
                                            </div>
                                            <div class="version-content">
                                                <div class="version-info">
                                                    <div class="version-uploader">Uploaded by: ${version.uploadedBy || 'Unknown'}</div>
                                                    <div class="version-environment-info">
                                                        <span class="environment-label">Environment:</span>
                                                        <span class="environment-value ${version.environment || 'undefined'}">${getEnvironmentLabel(version.environment)}</span>
                                                    </div>
                                                    ${version.buildNumber ? `<div class="version-build-number">Build: ${version.buildNumber}</div>` : ''}
                                                    <div class="version-notes">${version.notes || 'No notes'}</div>
                                                </div>
                                                <div class="version-actions">
                                                    <div class="modern-buttons-container">
                                                        <button class="modern-button download-button" ontouchstart="" onclick="event.stopPropagation(); downloadVersion('${project.id}', '${version.id}')">
                                                            <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                                                            </svg>
                                                            Download
                                                        </button>
                                                        <button class="modern-button delete-button" onclick="event.stopPropagation(); deleteVersion('${project.id}', '${version.id}')">
                                                            <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                                            </svg>
                                                            Delete
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                            ${platforms.onvotv.length > 0 ? `
                                <div class="platform-item">
                                    <div class="platform-header">
                                        <span>üì∫ Onvo TV</span>
                                    </div>
                                    ${platforms.onvotv.map(version => `
                                        <div class="version-item" onclick="toggleVersion(event, this)">
                                            <div class="version-header">
                                                <div class="version-title">
                                                    <span class="version-number">v${version.version || 'N/A'}${version.buildNumber ? ` (${version.buildNumber})` : ''}</span>
                                                    <span class="version-environment ${version.environment || 'undefined'}">${getEnvironmentLabel(version.environment)}</span>
                                                    <span class="version-date">${new Date(version.uploadedAt).toLocaleString()}</span>
                                                </div>
                                                <div class="version-toggle">‚ñº</div>
                                            </div>
                                            <div class="version-content">
                                                <div class="version-info">
                                                    <div class="version-uploader">Uploaded by: ${version.uploadedBy || 'Unknown'}</div>
                                                    <div class="version-environment-info">
                                                        <span class="environment-label">Environment:</span>
                                                        <span class="environment-value ${version.environment || 'undefined'}">${getEnvironmentLabel(version.environment)}</span>
                                                    </div>
                                                    ${version.buildNumber ? `<div class="version-build-number">Build: ${version.buildNumber}</div>` : ''}
                                                    <div class="version-notes">${version.notes || 'No notes'}</div>
                                                </div>
                                                <div class="version-actions">
                                                    <div class="modern-buttons-container">
                                                        <button class="modern-button download-button" ontouchstart="" onclick="event.stopPropagation(); downloadVersion('${project.id}', '${version.id}')">
                                                            <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                                                            </svg>
                                                            Download
                                                        </button>
                                                        <button class="modern-button delete-button" onclick="event.stopPropagation(); deleteVersion('${project.id}', '${version.id}')">
                                                            <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                                            </svg>
                                                            Delete
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                            ${(!platforms.ios.length && !platforms.android.length && !platforms.tvos.length && !platforms.androidtv.length && !platforms.huawei.length && !platforms.onvotv.length) ? `
                                <div class="empty-platform-message">
                                    <p>No versions uploaded yet</p>
                                </div>
                            ` : ''}
                        </div>
                    `;
                    
                    container.appendChild(card);
                });

                // Pagination controls eklendikten sonra, butonlarƒ± g√ºncelle
                updateActionButtons();
                
                // Sayfalama kontrollerini ekle
                if (data.totalPages > 1) {
                    const paginationDiv = document.createElement('div');
                    paginationDiv.className = 'pagination';
                    paginationDiv.innerHTML = `
                        ${data.currentPage > 1 ? 
                            `<button onclick="showAllApps(${data.currentPage - 1})">Previous</button>` : ''}
                        <span>Page ${data.currentPage} of ${data.totalPages}</span>
                        ${data.currentPage < data.totalPages ? 
                            `<button onclick="showAllApps(${data.currentPage + 1})">Next</button>` : ''}
                    `;
                    container.appendChild(paginationDiv);
                }
            } catch (error) {
                console.error('Error loading apps:', error);
                showNotification('Failed to load apps', 'error');
            }
        }

        async function deleteProject(projectId) {
            showConfirmDialog('Are you sure you want to delete this project?', async () => {
                try {
                    const response = await fetch(`${CONFIG.baseUrl}/api/projects/${projectId}`, {
                        method: 'DELETE',
                        credentials: 'include'
                    });

                    const data = await response.json();
                    if (data.success) {
                        showNotification('Project deleted successfully', 'success');
                        showAllApps();
                    } else {
                        showNotification(data.error || 'Failed to delete project', 'error');
                    }
                } catch (error) {
                    console.error('Delete error:', error);
                    showNotification('Failed to delete project', 'error');
                }
            }, 'project');
        }

        function showConfirmDialog(message, onConfirm, type = 'project') {
            const backdrop = document.createElement('div');
            backdrop.className = 'confirm-dialog-backdrop';
            
            const dialog = document.createElement('div');
            dialog.className = 'confirm-dialog';
            dialog.innerHTML = `
                <h3>Delete ${type === 'project' ? 'Project' : 'Version'}</h3>
                <p>${message}</p>
                <div class="confirm-dialog-actions">
                    <button class="confirm-dialog-cancel" onclick="closeConfirmDialog()">Cancel</button>
                    <button class="confirm-dialog-delete" onclick="handleConfirm()">Delete</button>
                </div>
            `;
            
            document.body.appendChild(backdrop);
            document.body.appendChild(dialog);
            
            // Arka plana tƒ±klandƒ±ƒüƒ±nda dialogu kapat
            backdrop.addEventListener('click', (e) => {
                if (e.target === backdrop) {
                    closeConfirmDialog();
                }
            });
            
            // ESC tu≈üuna basƒ±ldƒ±ƒüƒ±nda dialogu kapat
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeConfirmDialog();
                }
            });
            
            window.handleConfirm = () => {
                onConfirm();
                closeConfirmDialog();
            };
        }
        
        function closeConfirmDialog() {
            const backdrop = document.querySelector('.confirm-dialog-backdrop');
            const dialog = document.querySelector('.confirm-dialog');
            if (backdrop) backdrop.remove();
            if (dialog) dialog.remove();
        }

        async function handleUpload(event) {
            event.preventDefault();
            
            const form = event.target;
            const platform = document.getElementById('platformSelect').value;

            // For file uploads, ensure all required fields are present and enabled
            if (platform !== 'ios' && platform !== 'tvos') {
                // Set default values if missing
                const projectIdInput = document.getElementById('projectIdInput');
                const versionInput = document.getElementById('versionInput');
                const environmentSelect = document.getElementById('environmentSelect');
                if (!projectIdInput.value) {
                    showUploadError('Project is required');
                    return;
                }
                if (!versionInput.value) {
                    versionInput.value = '1.0.0';
                }
                if (!environmentSelect.value) {
                    environmentSelect.value = 'production';
                }
                // Ensure fields are enabled
                projectIdInput.disabled = false;
                versionInput.disabled = false;
                environmentSelect.disabled = false;
            }
            
            const formData = new FormData(form);
            // Ensure platform is always included in FormData for file uploads
            if (platform !== 'ios' && platform !== 'tvos') {
                formData.set('platform', platform);
            }
            const submitButton = form.querySelector('button[type="submit"]');
            
            // Store original button content
            const originalContent = submitButton.innerHTML;
            
            // Update button appearance
            submitButton.disabled = true;
            submitButton.innerHTML = `
                <svg class="animate-spin" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" stroke-dasharray="30 30" stroke-dashoffset="0"></circle>
                    <path fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span class="progress-text">Starting upload...</span>
            `;
            
            // iOS ve Apple TV platformlarƒ± i√ßin sadece URL
            if (platform === 'ios' || platform === 'tvos') {
                const url = document.getElementById('appUrl').value;
                if (!url) {
                    showUploadError('Public Test URL is required for iOS and Apple TV platforms');
                    submitButton.innerHTML = originalContent;
                    submitButton.disabled = false;
                    return;
                }
                
                const projectId = document.getElementById('projectIdInput').value;
                removeUploadError();
                try {
                    const response = await fetch(`${CONFIG.baseUrl}/api/submit`, {
                        method: 'POST',
                        credentials: 'include',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            projectId: projectId,
                            platform: platform,
                            environment: 'production',
                            url: url
                        })
                    });
                    const data = await response.json();
                    if (data.success) {
                        showNotification('URL submitted successfully', 'success');
                        closeModal('uploadModal');
                        showAllApps();
                        submitButton.innerHTML = originalContent;
                        submitButton.disabled = false;
                        return;
                    } else {
                        showUploadError(data.error || 'Failed to submit URL');
                        submitButton.innerHTML = originalContent;
                        submitButton.disabled = false;
                        return;
                    }
                } catch (error) {
                    console.error('Submit error:', error);
                    showUploadError('Failed to submit URL');
                    submitButton.innerHTML = originalContent;
                    submitButton.disabled = false;
                    return;
                }
            } else {
                const file = document.getElementById('appFile').files[0];
                if (!file) {
                    showUploadError('App file is required for this platform');
                    submitButton.innerHTML = originalContent;
                    submitButton.disabled = false;
                    return;
                }

                // Validate file extension
                const allowedExtensions = ['.apk', '.aab', '.ipa', '.zip'];
                const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
                
                if (!allowedExtensions.includes(fileExtension)) {
                    showUploadError('Invalid file format. Please upload APK, AAB, IPA, or ZIP file.');
                    submitButton.innerHTML = originalContent;
                    submitButton.disabled = false;
                    return;
                }

                // Platform specific validation
                if (platform === 'android' || platform === 'huawei') {
                    if (fileExtension !== '.apk' && fileExtension !== '.aab') {
                        showUploadError('For Android and Huawei platforms, please upload APK or AAB file.');
                        submitButton.innerHTML = originalContent;
                        submitButton.disabled = false;
                        return;
                    }
                }
                
                // Check file size and show warning for large files
                const fileSizeMB = file.size / (1024 * 1024);
                if (fileSizeMB > 20) {
                    showLargeFileModal(fileSizeMB, formData, submitButton, originalContent);
                    return;
                }
            }
            
            const projectId = document.getElementById('projectIdInput').value;
            removeUploadError();
            
            try {
                // Create AbortController for timeout handling
                const controller = new AbortController();
                const timeoutId = setTimeout(() => {
                    controller.abort();
                }, 60 * 60 * 1000); // 60 minutes timeout for large files

                const response = await fetch(`${CONFIG.baseUrl}/api/upload`, {
                    method: 'POST',
                    credentials: 'include',
                    body: formData,
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                // Create a reader for server-sent events
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || ''; // Keep the last incomplete line in the buffer
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                
                                // Handle different message types
                                if (data.type === 'connection') {
                                    console.log('Upload connection established');
                                }
                                
                                if (data.type === 'fileInfo') {
                                    console.log(`File size: ${(data.fileSize / 1024 / 1024).toFixed(2)} MB`);
                                }
                                
                                if (data.type === 'info') {
                                    console.log(data.message);
                                    const progressText = submitButton.querySelector('.progress-text');
                                    if (progressText) {
                                        progressText.textContent = data.message;
                                    }
                                }
                                
                                if (data.type === 'progress' && data.progress) {
                                    // Update progress text
                                    const progressText = submitButton.querySelector('.progress-text');
                                    if (progressText) {
                                        const uploadedMB = (data.uploadedBytes / 1024 / 1024).toFixed(2);
                                        const totalMB = (data.fileSize / 1024 / 1024).toFixed(2);
                                        progressText.textContent = `Uploading: ${Math.round(data.progress)}% (${uploadedMB}MB / ${totalMB}MB)`;
                                    }
                                }
                                
                                if (data.type === 'complete' && data.success) {
                                    if (data.totalParts && data.totalParts > 1) {
                                        showNotification(`Large file successfully uploaded in ${data.totalParts} parts`, 'success');
                                    } else {
                                        showNotification('File uploaded successfully', 'success');
                                    }
                                    closeModal('uploadModal');
                                    showAllApps();
                                    submitButton.innerHTML = originalContent;
                                    submitButton.disabled = false;
                                    return;
                                }
                                
                                if (data.error) {
                                    showUploadError(data.error);
                                    submitButton.innerHTML = originalContent;
                                    submitButton.disabled = false;
                                    return;
                                }
                                
                                // Legacy support for old format
                                if (data.progress && !data.type) {
                                    const progressText = submitButton.querySelector('.progress-text');
                                    if (progressText) {
                                        progressText.textContent = `Uploading: ${Math.round(data.progress)}%`;
                                    }
                                }
                                
                                if (data.success && !data.type) {
                                    showNotification('File uploaded successfully', 'success');
                                    closeModal('uploadModal');
                                    showAllApps();
                                    submitButton.innerHTML = originalContent;
                                    submitButton.disabled = false;
                                    return;
                                }
                                
                            } catch (parseError) {
                                console.error('Error parsing SSE data:', parseError, line);
                            }
                        }
                    }
                }
                
                // If we reach here without success, show error
                showUploadError('Upload completed but no success response received');
                submitButton.innerHTML = originalContent;
                submitButton.disabled = false;
                
            } catch (error) {
                console.error('Upload error:', error);
                
                if (error.name === 'AbortError') {
                    showUploadError('Upload timed out. Please try again with a smaller file or check your connection.');
                } else if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                    showUploadError('Connection failed. Please check your internet connection and try again.');
                } else {
                    showUploadError(`Upload failed: ${error.message}`);
                }
                
                submitButton.innerHTML = originalContent;
                submitButton.disabled = false;
            }
        }

        document.getElementById('uploadForm').addEventListener('submit', handleUpload);

        function showUploadError(message) {
            removeUploadError();
            
            const uploadForm = document.getElementById('uploadForm');
            const fileInput = document.getElementById('appFile');
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'upload-error';
            errorDiv.innerHTML = `
                <div class="upload-error-icon">
                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                              d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
                <span>${message}</span>
            `;
            
            fileInput.parentNode.insertBefore(errorDiv, fileInput.nextSibling);
        }

        function removeUploadError() {
            const existingError = document.querySelector('.upload-error');
            if (existingError) {
                existingError.remove();
            }
        }

        function showNotification(message, type = 'success') {
            // Create notification
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            notification.style.zIndex = '9999';
            
            // Add to body
            document.body.appendChild(notification);
            
            // Auto-remove after 3 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }

        async function downloadVersion(projectId, versionId) {
            try {
                // Get the button that was clicked
                const clickedButton = event.target.closest('button');
                
                // Disable the button and show loading state
                if (clickedButton) {
                    // Store original button content
                    const originalContent = clickedButton.innerHTML;
                    
                    // Update button appearance
                    clickedButton.disabled = true;
                    clickedButton.innerHTML = `
                        <svg class="animate-spin" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" stroke-dasharray="30 30" stroke-dashoffset="0"></circle>
                            <path fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span class="progress-text">Starting...</span>
                    `;

                    // Create fetch request with progress tracking
                    const response = await fetch(`${CONFIG.baseUrl}/api/download/${projectId}/${versionId}`, {
                        method: 'GET',
                        credentials: 'include'
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Failed to download file');
                    }

                    // Get total file size
                    const totalSize = parseInt(response.headers.get('Content-Length'), 10);
                    const contentDisposition = response.headers.get('Content-Disposition');
                    const fileName = contentDisposition?.split('filename=')[1]?.replace(/"/g, '') || 'download';

                    // Create a ReadableStream to track progress
                    const reader = response.body.getReader();
                    let receivedLength = 0;
                    const chunks = [];

                    while(true) {
                        const {done, value} = await reader.read();
                        
                        if (done) {
                            break;
                        }
                        
                        chunks.push(value);
                        receivedLength += value.length;
                        
                        // Calculate and show progress
                        const progress = (receivedLength / totalSize) * 100;
                        const progressText = `${Math.round(progress)}%`;
                        const progressSpan = clickedButton.querySelector('.progress-text');
                        if (progressSpan) {
                            progressSpan.textContent = progressText;
                        }
                    }

                    // Concatenate chunks into a single Uint8Array
                    const chunksAll = new Uint8Array(receivedLength);
                    let position = 0;
                    for(let chunk of chunks) {
                        chunksAll.set(chunk, position);
                        position += chunk.length;
                    }

                    // Create and download blob
                    const blob = new Blob([chunksAll]);
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = fileName;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);

                    showNotification('Download completed', 'success');
                    
                    // Restore button state after download completes
                    if (clickedButton) {
                        setTimeout(() => {
                            clickedButton.innerHTML = originalContent;
                            clickedButton.disabled = false;
                        }, 1000);
                    }
                }
            } catch (error) {
                console.error('Download error:', error);
                showNotification(error.message, 'error');
                
                // If error occurs, restore the button
                const clickedButton = event.target.closest('button');
                if (clickedButton) {
                    const defaultIcon = `<svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                    </svg>
                    Download`;
                    clickedButton.innerHTML = defaultIcon;
                    clickedButton.disabled = false;
                }
            }
        }

        function toggleProject(event, element) {
            if (event.target.closest('.app-actions') || 
                event.target.closest('.version-actions')) {
                return;
            }
            
            const wasActive = element.classList.contains('active');
            
            document.querySelectorAll('.app-card').forEach(card => {
                if (card !== element) {
                    card.classList.remove('active');
                }
            });
            
            element.classList.toggle('active', !wasActive);
        }

        function toggleVersion(event, element) {
            event.stopPropagation(); // Prevent project toggle
            
            const wasActive = element.classList.contains('active');
            
            // Aynƒ± seviyedeki diƒüer versiyonlarƒ± kapat
            const siblings = element.parentElement.querySelectorAll('.version-item');
            siblings.forEach(sibling => {
                if (sibling !== element) {
                    sibling.classList.remove('active');
                }
            });
            
            element.classList.toggle('active', !wasActive);
        }

        async function deleteVersion(projectId, versionId) {
            showConfirmDialog('Are you sure you want to delete this version?', async () => {
                try {
                    const response = await fetch(`${CONFIG.baseUrl}/api/projects/${projectId}/versions/${versionId}`, {
                        method: 'DELETE',
                        credentials: 'include',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    
                    if (data.success) {
                        showNotification('Version deleted successfully', 'success');
                        await showAllApps();
                        await showRecentUploads();
                    } else {
                        throw new Error(data.error || 'Failed to delete version');
                    }
                } catch (error) {
                    console.error('Delete version error:', error);
                    showNotification(error.message, 'error');
                } finally {
                    closeConfirmDialog();
                }
            }, 'version');
        }

        async function showRecentUploads() {
            try {
                const response = await fetch(`${CONFIG.baseUrl}/api/projects`, {
                    credentials: 'include'
                });
                const projects = await response.json();
                
                const fiveDaysAgo = new Date();
                fiveDaysAgo.setDate(fiveDaysAgo.getDate() - 5);
                
                allVersions = projects.reduce((versions, project) => {
                    const projectVersions = project.versions.map(version => ({
                        ...version,
                        projectName: project.name,
                        projectId: project.id
                    }));
                    return [...versions, ...projectVersions];
                }, []);
                
                allVersions = allVersions
                    .filter(version => new Date(version.uploadedAt) >= fiveDaysAgo)
                    .sort((a, b) => new Date(b.uploadedAt) - new Date(a.uploadedAt));

                localStorage.setItem('recentUploads', JSON.stringify(allVersions));

                filteredVersions = [];
                currentPage = 1;

                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                const osFilter = document.getElementById('osFilter').value;
                const typeFilter = document.getElementById('typeFilter').value;

                if (searchTerm || osFilter !== 'all' || typeFilter !== 'all') {
                    filterUploads();
                } else {
                    updateRecentUploadsList();
                }
            } catch (error) {
                console.error('Error loading recent uploads:', error);
            }
        }

        function filterUploads() {
            const searchText = document.getElementById('searchInput').value.toLowerCase();
            const osFilter = document.getElementById('osFilter').value;
            
            document.querySelectorAll('.app-card').forEach(card => {
                const title = card.querySelector('.app-title').textContent.toLowerCase();
                const hasMatchingVersion = Array.from(card.querySelectorAll('.platform-item')).some(platform => {
                    const platformType = platform.querySelector('.platform-header').textContent.toLowerCase();
                    return osFilter === 'all' || 
                           (osFilter === 'ios' && platformType.includes('ios')) ||
                           (osFilter === 'android' && platformType.includes('android') && !platformType.includes('tv')) ||
                           (osFilter === 'tvos' && platformType.includes('apple tv')) ||
                           (osFilter === 'androidtv' && platformType.includes('android tv')) ||
                           (osFilter === 'huawei' && platformType.includes('huawei'));
                });

                const matchesSearch = title.includes(searchText);
                card.style.display = (matchesSearch && (osFilter === 'all' || hasMatchingVersion)) ? 'block' : 'none';
            });
        }

        function updateRecentUploadsList() {
            const versionsToShow = filteredVersions.length > 0 ? filteredVersions : allVersions;
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const currentVersions = versionsToShow.slice(startIndex, endIndex);
            
            const container = document.getElementById('recentUploads');
            if (container) {
                container.innerHTML = currentVersions.map(version => `
                    <div class="version-card">
                        <div class="version-header">
                            <span class="project-name">${version.projectName}</span>
                            <span class="platform-badge ${version.platform}">${version.platform === 'ios' ? 'üçé' : version.platform === 'android' ? 'ü§ñ' : version.platform === 'tvos' ? 'üì∫' : 'üì∫'} ${version.platform}</span>
                        </div>
                        <div class="version-details">
                            <div class="version-number">v${version.version}</div>
                            <div class="upload-time">${new Date(version.uploadedAt).toLocaleString()}</div>
                            <div class="uploader">Uploaded by: ${version.uploadedBy || 'Unknown'}</div>
                            <div class="notes">${version.notes}</div>
                        </div>
                    </div>
                `).join('');
            }
            
            updatePagination(versionsToShow.length);
        }

        function updatePagination(totalItems) {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const paginationContainer = document.getElementById('pagination');
            
            if (paginationContainer) {
                let paginationHTML = '';
                
                if (totalPages > 1) {
                    if (currentPage > 1) {
                        paginationHTML += `<button onclick="changePage(${currentPage - 1})">Previous</button>`;
                    }
                    
                    paginationHTML += `<span>Page ${currentPage}</span>`;
                    
                    if (currentPage < totalPages) {
                        paginationHTML += `<button onclick="changePage(${currentPage + 1})">Next</button>`;
                    }
                }
                
                paginationContainer.innerHTML = paginationHTML;
            }
        }

        function changePage(newPage) {
            currentPage = newPage;
            updateRecentUploadsList();
        }

        function getEnvironmentLabel(env) {
            const labels = {
                'production': 'üöÄ Market',
                'test': 'üß™ Test',
                'regression': 'üîÑ Regression'
            };
            // If env value exists and is in labels, return it, otherwise return Unknown
            return env && labels[env] ? labels[env] : '‚ùì Unknown';
        }

        // Add Intersection Observer for lazy loading
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const versionList = entry.target;
                    loadVersions(versionList.dataset.projectId);
                    observer.unobserve(versionList);
                }
            });
        }, { threshold: 0.1 });

        function loadVersions(projectId) {
            const versionList = document.querySelector(`#versions-${projectId}`);
            if (!versionList.children.length) {
                // Versiyonlarƒ± y√ºkle
                // ... versiyon y√ºkleme kodu ...
            }
        }

        // Let's update the version loading function
        function loadVersionsForProject(project, container) {
            const platforms = {
                ios: project.versions?.filter(v => v.platform === 'ios').slice(0, 5) || [],
                android: project.versions?.filter(v => v.platform === 'android').slice(0, 5) || [],
                tvos: project.versions?.filter(v => v.platform === 'tvos').slice(0, 5) || [],
                androidtv: project.versions?.filter(v => v.platform === 'androidtv').slice(0, 5) || [],
                huawei: project.versions?.filter(v => v.platform === 'huawei').slice(0, 5) || [],
                onvotv: project.versions?.filter(v => v.platform === 'onvotv').slice(0, 5) || []
            };

            // Show only the last 5 versions for each platform
            Object.entries(platforms).forEach(([platform, versions]) => {
                if (versions.length) {
                    const platformDiv = document.createElement('div');
                    platformDiv.className = 'platform-item';
                    // ... platform i√ßeriƒüi ...
                    
                    // "Show More" butonu ekle
                    if (project.versions.filter(v => v.platform === platform).length > 5) {
                        const showMoreBtn = document.createElement('button');
                        showMoreBtn.className = 'show-more-btn';
                        showMoreBtn.textContent = 'Show More';
                        showMoreBtn.onclick = () => loadMoreVersions(project.id, platform);
                        platformDiv.appendChild(showMoreBtn);
                    }
                    
                    container.appendChild(platformDiv);
                }
            });
        }

        // Handle user registration
        async function handleRegister(event) {
            event.preventDefault();
            const errorDiv = document.getElementById('registerError');
            if (!errorDiv) return; // Eƒüer div yoksa fonksiyonu bitir
            errorDiv.innerText = '';
            errorDiv.style.display = 'none';
            removeLoginError();
            const username = document.getElementById('registerUsername').value;
            const password = document.getElementById('registerPassword').value;
            const email = document.getElementById('registerEmail').value;
            const fullName = document.getElementById('registerFullName').value;
            try {
                const response = await fetch(`${CONFIG.baseUrl}/api/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password, email, fullName })
                });
                const data = await response.json();
                if (data.success) {
                    errorDiv.style.color = '#15803d';
                    errorDiv.innerText = 'Registration successful. Your account is pending approval by an administrator.';
                    errorDiv.style.display = 'block';
                    setTimeout(() => {
                        document.querySelector('.auth-toggle-btn[data-target="loginForm"]').click();
                    }, 2000);
                } else {
                    errorDiv.style.color = '#b91c1c';
                    errorDiv.innerText = data.error || 'Registration failed';
                    errorDiv.style.display = 'block';
                    errorDiv.style.border = '1px solid #b91c1c';
                    errorDiv.style.padding = '8px';
                    errorDiv.style.marginTop = '10px';
                    errorDiv.style.borderRadius = '4px';
                }
            } catch (error) {
                errorDiv.style.color = '#b91c1c';
                errorDiv.innerText = 'Registration failed. Please try again.';
                errorDiv.style.display = 'block';
                errorDiv.style.border = '1px solid #b91c1c';
                errorDiv.style.padding = '8px';
                errorDiv.style.marginTop = '10px';
                errorDiv.style.borderRadius = '4px';
            }
        }
        
        // Check if user is admin
        async function checkAdminStatus() {
            try {
                const response = await fetch(`${CONFIG.baseUrl}/api/check-admin`, {
                    credentials: 'include'
                });
                
                const data = await response.json();
                if (data.isAdmin) {
                    // Show admin panel button
                    document.getElementById('adminPanelButton').style.display = 'inline-block';
                    
                    // Show edit buttons for admin users
                    document.querySelectorAll('.edit-button').forEach(button => {
                        button.style.display = 'inline-flex';
                    });
                } else {
                    document.getElementById('adminPanelButton').style.display = 'none';
                    
                    // Hide edit buttons for non-admin users
                    document.querySelectorAll('.edit-button').forEach(button => {
                        button.style.display = 'none';
                    });
                }
            } catch (error) {
                console.error('Admin check error:', error);
            }
        }
        
        // Show admin panel
        function showAdminPanel() {
            loadUsers();
            document.getElementById('usersAdminModal').style.display = 'flex';
        }
        
        // Load users for admin panel
        async function loadUsers() {
            try {
                const response = await fetch(`${CONFIG.baseUrl}/api/users`, {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error(`Error: ${response.status}`);
                }
                
                const data = await response.json();
                
                const usersList = document.getElementById('usersList');
                usersList.innerHTML = '';
                
                // Group users into pending and approved
                const pendingUsers = data.users.filter(user => !user.approved);
                const approvedUsers = data.users.filter(user => user.approved);
                
                // Show pending users first
                if (pendingUsers.length > 0) {
                    const pendingSection = document.createElement('div');
                    pendingSection.className = 'users-section';
                    pendingSection.innerHTML = '<h3>Pending Approval</h3>';
                    
                    pendingUsers.forEach(user => {
                        const userItem = createUserItem(user);
                        pendingSection.appendChild(userItem);
                    });
                    
                    usersList.appendChild(pendingSection);
                }
                
                // Then show approved users
                if (approvedUsers.length > 0) {
                    const approvedSection = document.createElement('div');
                    approvedSection.className = 'users-section';
                    approvedSection.innerHTML = '<h3>Approved Users</h3>';
                    
                    approvedUsers.forEach(user => {
                        const userItem = createUserItem(user);
                        approvedSection.appendChild(userItem);
                    });
                    
                    usersList.appendChild(approvedSection);
                }
                
                if (data.users.length === 0) {
                    usersList.innerHTML = '<p class="empty-state">No users found</p>';
                } else {
                    // After users are loaded, display their projects
                    data.users.forEach(user => {
                        if (user.approved && user.role !== 'admin') {
                            const projectListSpan = document.querySelector(`.user-projects[data-userid="${user.id}"] .project-list`);
                            if (projectListSpan) {
                                // Use the resolved 'projects' array from the API response
                                const projectNames = user.projects && user.projects.length > 0 
                                    ? user.projects.map(p => p.name).join(', ') 
                                    : 'No projects assigned';
                                projectListSpan.textContent = projectNames;
                            }
                        }
                    });
                    // Store fetched users data globally for modal use (consider a more robust state management for larger apps)
                    window.allUsersData = data.users; 
                }
            } catch (error) {
                console.error('Load users error:', error);
                document.getElementById('usersList').innerHTML = '<p class="error-message">Failed to load users</p>';
            }
        }
        
        // Create user item element for the admin panel
        function createUserItem(user) {
            const userItem = document.createElement('div');
            userItem.className = 'user-item';
            userItem.dataset.userId = user.id;
            // Add onclick for toggling
            userItem.onclick = (event) => {
                 // Prevent toggle if clicking on button/action area
                 if (event.target.closest('.user-actions') || event.target.closest('.user-delete-icon')) {
                    return;
                 }
                 toggleUserItem(userItem);
            };

            const currentUsername = localStorage.getItem('username');
            const isCurrentUser = user.username === currentUsername;

            // Create Header
            const header = document.createElement('div');
            header.className = 'user-item-header';
            header.innerHTML = `
                <div class="user-name">${user.fullName || user.username} ${isCurrentUser ? '<span class="current-user-indicator">(Current User)</span>' : ''}</div>
                <div class="user-item-toggle">‚ñº</div>
            `;

            // Create Content (Details + Actions)
            const content = document.createElement('div');
            content.className = 'user-item-content';

            // User Details
            const userDetailsDiv = document.createElement('div');
            userDetailsDiv.className = 'user-details';
            userDetailsDiv.innerHTML = `
                <div class="user-username">${user.username}</div> 
                ${user.email ? `<div class="user-email">${user.email}</div>` : ''}
                <div class="user-role">${user.role}</div>
                <div class="user-status">${user.approved ? 'Approved' : 'Pending'}</div>
                <div class="user-created">${new Date(user.created).toLocaleDateString()}</div>
                <div class="user-projects" data-userid="${user.id}" style="${user.approved && user.role !== 'admin' ? '' : 'display: none;'}">
                    <span class="project-list">Loading...</span> 
                </div>
            `;
            content.appendChild(userDetailsDiv);

            // Action Buttons (only if not current user)
            if (!isCurrentUser) {
                const userActions = document.createElement('div');
                userActions.className = 'user-actions';
                
                if (!user.approved) {
                    // Approve/Reject buttons for pending users
                    const approveBtn = document.createElement('button');
                    approveBtn.className = 'approve-btn';
                    approveBtn.textContent = 'Approve';
                    approveBtn.onclick = () => updateUserApproval(user.id, true);
                    userActions.appendChild(approveBtn);
                    
                    const rejectBtn = document.createElement('button');
                    rejectBtn.className = 'revoke-btn'; // Use revoke style for reject
                    rejectBtn.textContent = 'Reject';
                    rejectBtn.onclick = () => updateUserApproval(user.id, false);
                    userActions.appendChild(rejectBtn);
                } else {
                    // Actions for approved users
                    const revokeBtn = document.createElement('button');
                    revokeBtn.className = 'revoke-btn';
                    revokeBtn.textContent = 'Revoke Access';
                    revokeBtn.onclick = () => updateUserApproval(user.id, false);
                    userActions.appendChild(revokeBtn);
                    
                    if (user.role !== 'admin') {
                        const makeAdminBtn = document.createElement('button');
                        makeAdminBtn.className = 'admin-btn';
                        makeAdminBtn.textContent = 'Make Admin';
                        makeAdminBtn.onclick = () => updateUserRole(user.id, 'admin');
                        userActions.appendChild(makeAdminBtn);

                        const manageProjectsBtn = document.createElement('button');
                        manageProjectsBtn.className = 'manage-projects-btn';
                        manageProjectsBtn.textContent = 'Manage Projects';
                        manageProjectsBtn.onclick = (event) => {
                            event.stopPropagation(); // Prevent user item toggle
                            console.log(`Manage Projects button clicked for user ID: ${user.id}`);
                            showManageProjectsModal(user.id);
                        };
                        userActions.appendChild(manageProjectsBtn);
                    } else {
                        // Action for admin users (Revoke Admin)
                        const revokeAdminBtn = document.createElement('button');
                        revokeAdminBtn.className = 'revoke-admin-btn';
                        revokeAdminBtn.textContent = 'Revoke Admin';
                        revokeAdminBtn.onclick = () => updateUserRole(user.id, 'user');
                        userActions.appendChild(revokeAdminBtn);
                    }
                    // REMOVED the old delete button from here
                }
                content.appendChild(userActions);
            } else {
                 // Optionally add a placeholder or message if current user has no actions
                 // const noActionsMsg = document.createElement('div');
                 // noActionsMsg.className = 'no-actions-message';
                 // noActionsMsg.textContent = 'No actions available for current user.';
                 // content.appendChild(noActionsMsg);
            }

            // Append Header and Content to User Item
            userItem.appendChild(header);
            userItem.appendChild(content);
            
            return userItem;
        }

        // Function to toggle user item visibility
        function toggleUserItem(element) {
            // Optional: Close other open items first
            // document.querySelectorAll('.user-item.active').forEach(item => {
            //     if (item !== element) {
            //         item.classList.remove('active');
            //     }
            // });
            element.classList.toggle('active');
        }

        // Update user approval status
        async function updateUserApproval(userId, approved) {
            try {
                const response = await fetch(`${CONFIG.baseUrl}/api/users/${userId}/approval`, {
                    method: 'PUT',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ approved })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification(`User ${approved ? 'approved' : 'access revoked'} successfully`, 'success');
                    loadUsers(); // Reload user list
                } else {
                    showNotification(data.error || `Failed to ${approved ? 'approve' : 'revoke'} user`, 'error');
                }
            } catch (error) {
                console.error('Update user approval error:', error);
                showNotification(`Failed to ${approved ? 'approve' : 'revoke'} user`, 'error');
            }
        }
        
        // Update user role
        async function updateUserRole(userId, role) {
            try {
                const response = await fetch(`${CONFIG.baseUrl}/api/users/${userId}/role`, {
                    method: 'PUT',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ role })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification(`User role updated to ${role} successfully`, 'success');
                    loadUsers(); // Reload user list
                } else {
                    showNotification(data.error || `Failed to update user role`, 'error');
                }
            } catch (error) {
                console.error('Update user role error:', error);
                showNotification(`Failed to update user role`, 'error');
            }
        }

        // Delete user
        async function deleteUser(userId, username) {
            showConfirmDialog(`Are you sure you want to delete user "${username}"?`, async () => {
                try {
                    const response = await fetch(`${CONFIG.baseUrl}/api/users/${userId}`, {
                        method: 'DELETE',
                        credentials: 'include',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        showNotification('User deleted successfully', 'success');
                        loadUsers(); // Reload user list
                    } else {
                        showNotification(data.error || 'Failed to delete user', 'error');
                    }
                } catch (error) {
                    console.error('Delete user error:', error);
                    showNotification('Failed to delete user', 'error');
                }
            }, 'user');
        }

        // Update user permissions based on UI elements
        async function updateUserPermissions() {
            try {
                const response = await fetch(`${CONFIG.baseUrl}/api/check-admin`, {
                    credentials: 'include'
                });
                
                const data = await response.json();
                const isAdmin = data.isAdmin;
                localStorage.setItem('userRole', isAdmin ? 'admin' : 'user');
                
                // Show/hide project creation button
                const createProjectButton = document.querySelector('.create-project');
                if (createProjectButton) {
                    createProjectButton.style.display = isAdmin ? 'block' : 'none';
                }
                
                // Update all delete and upload buttons on all pages
                // This function will run when app-cards are created in showAllApps
                updateActionButtons();
            } catch (error) {
                console.error('Failed to update user permissions:', error);
            }
        }
        
        // Function to update delete and upload buttons
        function updateActionButtons() {
            const isAdmin = localStorage.getItem('userRole') === 'admin';
            
            // Update app card actions
            document.querySelectorAll('.app-actions').forEach(actionContainer => {
                const uploadBtn = actionContainer.querySelector('button:first-child');
                const deleteBtn = actionContainer.querySelector('button:last-child');
                
                if (uploadBtn) uploadBtn.style.display = isAdmin ? 'flex' : 'none';
                if (deleteBtn) deleteBtn.style.display = isAdmin ? 'flex' : 'none';
            });
            
            // Update all delete buttons inside version-actions
            document.querySelectorAll('.version-actions').forEach(versionActions => {
                const downloadBtn = versionActions.querySelector('.download-button');
                const editBtn = versionActions.querySelector('.edit-button');
                const deleteBtn = versionActions.querySelector('.delete-button');
                
                // Everyone can see the download button
                if (downloadBtn) downloadBtn.style.display = 'flex';
                
                // Only admins can see the edit button
                if (editBtn) editBtn.style.display = isAdmin ? 'flex' : 'none';
                
                // Only admins can see the delete button
                if (deleteBtn) deleteBtn.style.display = isAdmin ? 'flex' : 'none';
            });
        }

        // Add Intersection Observer for lazy loading
        function setupLazyLoading() {
            // ... existing code ...
        }

        // First get the current version
        fetch(`${CONFIG.baseUrl}/api/projects/${projectId}/versions/${versionId}`, {
            credentials: 'include'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.version) {
                const version = data.version;
                
                // Open edit modal
                const modal = document.getElementById('editVersionModal') || createEditVersionModal();
                
                // Fill form fields
                document.getElementById('editVersionId').value = version.id;
                document.getElementById('editProjectId').value = projectId;
                document.getElementById('editVersionNumber').value = version.version || '';
                document.getElementById('editEnvironment').value = version.environment || 'production';
                document.getElementById('editNotes').value = version.notes || '';
                document.getElementById('editUrl').value = version.url || '';
                document.getElementById('editPlatform').value = version.platform || '';
                
                // Show modal
                modal.style.display = 'flex';
            } else {
                showNotification('Version information could not be retrieved', 'error');
            }
        })
        .catch(error => {
            console.error('Version edit error:', error);
            showNotification('Version editing error', 'error');
        });

        // Create edit version modal if not exists
        function createEditVersionModal() {
            const modal = document.createElement('div');
            modal.id = 'editVersionModal';
            modal.className = 'modal';
            
            modal.innerHTML = `
                <div class="modal-content">
                    <h2>Edit Version</h2>
                    <form id="editVersionForm">
                        <input type="hidden" id="editVersionId">
                        <input type="hidden" id="editProjectId">
                        <input type="hidden" id="editPlatform">
                        
                        <div class="form-group">
                            <label for="editVersionNumber">Version</label>
                            <input type="text" id="editVersionNumber" name="version" placeholder="1.0.0">
                        </div>
                        
                        <div class="form-group">
                            <label for="editEnvironment">Environment</label>
                            <select id="editEnvironment" name="environment">
                                <option value="production">Production (Market)</option>
                                <option value="test">Test</option>
                                <option value="regression">Regression</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="editNotes">Test Notes</label>
                            <textarea id="editNotes" name="notes" rows="4"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="editUrl">URL</label>
                            <input type="url" id="editUrl" name="url" placeholder="https://">
                        </div>
                        
                        <div class="modal-actions">
                            <button type="button" class="cancel-btn" onclick="closeModal('editVersionModal')">Cancel</button>
                            <button type="submit" class="create-btn">Update</button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Add submit handler
            document.getElementById('editVersionForm').addEventListener('submit', handleEditVersionSubmit);
            
            return modal;
        }

        // Handle edit version submit
        async function handleEditVersionSubmit(event) {
            event.preventDefault();
            
            const versionId = document.getElementById('editVersionId').value;
            const projectId = document.getElementById('editProjectId').value;
            const version = document.getElementById('editVersionNumber').value;
            const environment = document.getElementById('editEnvironment').value;
            const notes = document.getElementById('editNotes').value;
            const url = document.getElementById('editUrl').value;
            const platform = document.getElementById('editPlatform').value;

            // If version is 'URL Only', require URL
            if (version === 'URL Only' && (!url || url.trim() === '')) {
                showNotification('URL is required for URL Only versions', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${CONFIG.baseUrl}/api/projects/${projectId}/versions/${versionId}`, {
                    method: 'PUT',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        version,
                        environment,
                        notes,
                        url,
                        platform
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Version updated successfully', 'success');
                    closeModal('editVersionModal');
                    await showAllApps();
                    await showRecentUploads();
                } else {
                    showNotification('Version editing error', 'error');
                }
            } catch (error) {
                console.error('Version update error:', error);
                showNotification('Version editing error', 'error');
            }
        }

        // This function will be called when app-cards are created in showAllApps
        updateActionButtons();

        // Add touch events handler for mobile
        document.addEventListener('touchstart', function() {
            // This empty handler enables :active CSS states on iOS
        }, false);

        function toggleFileOrUrlInput() {
            const platform = document.getElementById('platformSelect').value;
            const fileGroup = document.getElementById('appFileGroup');
            const urlGroup = document.getElementById('appUrlGroup');
            const fileInput = document.getElementById('appFile');
            const urlInput = document.getElementById('appUrl');
            const standardFields = document.getElementById('standardFieldsGroup');
            const urlOnlyFields = document.getElementById('urlOnlyFieldsGroup');
            
            // If no platform is selected, hide all form fields
            if (!platform) {
                fileGroup.style.display = 'none';
                urlGroup.style.display = 'none';
                standardFields.style.display = 'none';
                urlOnlyFields.style.display = 'none';
                return;
            }
            
            if (platform === 'ios' || platform === 'tvos') {
                fileGroup.style.display = 'none';
                urlGroup.style.display = 'block';
                standardFields.style.display = 'none';
                urlOnlyFields.style.display = 'block';
                fileInput.removeAttribute('required');
                urlInput.setAttribute('required', 'required');
                
                // Remove required attribute from the standard fields
                document.getElementById('versionInput').removeAttribute('required');
                document.getElementById('environmentSelect').removeAttribute('required');
            } else {
                fileGroup.style.display = 'block';
                urlGroup.style.display = 'none';
                standardFields.style.display = 'block';
                urlOnlyFields.style.display = 'none';
                fileInput.setAttribute('required', 'required');
                urlInput.removeAttribute('required');
                
                // Restore required attribute to the standard fields
                document.getElementById('versionInput').setAttribute('required', 'required');
                document.getElementById('environmentSelect').setAttribute('required', 'required');
            }
        }

        // Hide form fields
        function hideAllUploadFields() {
            document.getElementById('standardFieldsGroup').style.display = 'none';
            document.getElementById('urlOnlyFieldsGroup').style.display = 'none';
            document.getElementById('appFileGroup').style.display = 'none';
            document.getElementById('appUrlGroup').style.display = 'none';
        }

        // Initialize when the modal opens
        function openUploadModal(projectId, projectName) {
            document.getElementById('projectIdInput').value = projectId;
            document.getElementById('uploadProjectName').textContent = projectName;
            document.getElementById('uploadForm').reset();
            
            // Clear file input and file info display
            const fileInput = document.getElementById('appFile');
            if (fileInput) fileInput.value = '';
            const fileInfo = document.getElementById('jiraFileInfo');
            if (fileInfo) {
                fileInfo.innerHTML = '';
                fileInfo.style.display = 'none';
            }
            const uploadText = document.getElementById('jiraUploadText');
            if (uploadText) uploadText.style.display = '';
            
            // Clear platform selection (add empty option)
            const platformSelect = document.getElementById('platformSelect');
            platformSelect.innerHTML = '<option value="">Please select a platform</option>' +
                                     '<option value="ios">iOS</option>' +
                                     '<option value="android">Android</option>' +
                                     '<option value="tvos">Apple TV</option>' +
                                     '<option value="androidtv">Android TV</option>' +
                                     '<option value="huawei">Huawei</option>' +
                                     '<option value="onvotv">Onvo TV</option>';
            
            // Hide all fields
            hideAllUploadFields();
            
            // Open the modal
            document.getElementById('uploadModal').style.display = 'flex';
        }

        // Edit version function
        function editVersion(projectId, versionId) {
            event.stopPropagation(); // Prevent version toggle
            fetch(`${CONFIG.baseUrl}/api/projects/${projectId}/versions/${versionId}`, {
                credentials: 'include'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.version) {
                    const version = data.version;
                    // Open edit modal
                    const modal = document.getElementById('editVersionModal') || createEditVersionModal();
                    // Fill form fields
                    document.getElementById('editVersionId').value = version.id;
                    document.getElementById('editProjectId').value = projectId;
                    document.getElementById('editVersionNumber').value = version.version || '';
                    document.getElementById('editEnvironment').value = version.environment || 'production';
                    document.getElementById('editNotes').value = version.notes || '';
                    document.getElementById('editUrl').value = version.url || '';
                    document.getElementById('editPlatform').value = version.platform || '';
                    // Show modal
                    modal.style.display = 'flex';
                } else {
                    showNotification('Version information could not be retrieved', 'error');
                }
            })
            .catch(error => {
                console.error('Version edit error:', error);
                showNotification('Version editing error', 'error');
            });
        }

        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Deactivate all tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName).classList.add('active');
            
            // Activate selected tab button
            document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');
            
            // Load content based on tab
            if (tabName === 'userManagement') {
                loadUsers();
            } else if (tabName === 'apiKeyManagement') {
                loadApiKeys();
            }
        }

        async function loadApiKeys() {
            try {
                const response = await fetch(`${CONFIG.baseUrl}/api/keys`, {
                    method: 'GET',
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Failed to load API keys');
                }

                const keys = await response.json();
                const tbody = document.querySelector('#apiKeysList tbody');
                tbody.innerHTML = '';

                keys.forEach(key => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${key.description}</td>
                        <td>${new Date(key.createdAt).toLocaleString()}</td>
                        <td>${key.lastUsed ? new Date(key.lastUsed).toLocaleString() : 'Never'}</td>
                        <td>${key.isActive ? '<span class="badge success">Active</span>' : '<span class="badge error">Inactive</span>'}</td>
                        <td class="actions-cell">
                            <button class="delete-btn-small" onclick="event.stopPropagation(); showConfirmDialog('Are you sure you want to delete this API key?', () => deleteApiKey('${key.id}'))">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M3 6h18"></path>
                                    <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                                    <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                                </svg>
                            </button>
                        </td>
                    `;

                    // Add click event to show/hide API key
                    tr.style.cursor = 'pointer';
                    tr.onclick = () => {
                        // Remove any existing key rows
                        const existingKeyRows = document.querySelectorAll('.api-key-row');
                        existingKeyRows.forEach(row => {
                            if (row !== tr.nextElementSibling) {
                                row.remove();
                            }
                        });

                        // Toggle this key row
                        const existingKeyRow = tr.nextElementSibling;
                        if (existingKeyRow && existingKeyRow.classList.contains('api-key-row')) {
                            existingKeyRow.remove();
                        } else {
                            const keyRow = document.createElement('tr');
                            keyRow.className = 'api-key-row';
                            keyRow.innerHTML = `
                                <td colspan="5">
                                    <div class="api-key-display">
                                        <input type="text" class="api-key-value" value="${key.key}" readonly onclick="this.select();" />
                                        <div class="api-key-actions">
                                            <button class="copy-btn" onclick="event.stopPropagation(); copyApiKey('${key.key}')">
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                                </svg>
                                                Copy
                                            </button>
                                        </div>
                                    </div>
                                </td>
                            `;
                            tr.parentNode.insertBefore(keyRow, tr.nextSibling);
                            
                            // Auto select the API key
                            const input = keyRow.querySelector('.api-key-value');
                            input.select();
                        }
                    };

                    tbody.appendChild(tr);
                });
            } catch (error) {
                console.error('Error loading API keys:', error);
                showNotification(error.message, 'error');
            }
        }

        function generateApiKey() {
            document.getElementById('apiKeyDialog').style.display = 'flex';
        }

        function closeApiKeyDialog() {
            document.getElementById('apiKeyDialog').style.display = 'none';
            document.getElementById('apiKeyForm').reset();
        }

        async function handleApiKeyGeneration(event) {
            event.preventDefault();
            
            const description = document.getElementById('apiKeyDescription').value;
            
            try {
                const response = await fetch(`${CONFIG.baseUrl}/api/keys`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ description })
                });

                if (!response.ok) {
                    throw new Error('Failed to generate API key');
                }

                const data = await response.json();
                showNotification('API key generated successfully', 'success');
                closeApiKeyDialog();
                loadApiKeys();
            } catch (error) {
                console.error('Error generating API key:', error);
                showNotification(error.message, 'error');
            }
        }

        async function deleteApiKey(keyId) {
            showConfirmDialog('Are you sure you want to delete this API key?', async () => {
                try {
                    const response = await fetch(`${CONFIG.baseUrl}/api/keys/${keyId}`, {
                        method: 'DELETE',
                        credentials: 'include'
                    });

                    if (!response.ok) {
                        throw new Error('Failed to delete API key');
                    }

                    showNotification('API key deleted successfully', 'success');
                    loadApiKeys();
                } catch (error) {
                    console.error('Error deleting API key:', error);
                    showNotification(error.message, 'error');
                }
            });
        }

        async function copyApiKey(key) {
            try {
                // First try using the modern Clipboard API
                if (navigator.clipboard && window.isSecureContext) {
                    await navigator.clipboard.writeText(key);
                    showNotification('API key copied to clipboard', 'success');
                    return;
                }
                
                // Fallback method using a temporary textarea element
                const textArea = document.createElement('textarea');
                textArea.value = key;
                
                // Make the textarea hidden but still part of the document
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                textArea.style.top = '-999999px';
                document.body.appendChild(textArea);
                
                // Select and copy the text
                textArea.focus();
                textArea.select();
                
                try {
                    document.execCommand('copy');
                    showNotification('API key copied to clipboard', 'success');
                } catch (err) {
                    showNotification('Failed to copy API key: ' + err.message, 'error');
                } finally {
                    // Clean up
                    textArea.remove();
                }
            } catch (error) {
                console.error('Copy error:', error);
                
                // Show specific error message based on the error
                if (error.name === 'NotAllowedError') {
                    showNotification('Copy permission denied. Please use the manual copy method.', 'error');
                } else {
                    showNotification('Failed to copy API key: ' + error.message, 'error');
                }
            }
        }

        // --- Project Management Functions ---

        // let currentEditingUserId = null; // Remove original declaration from here

        // Show the modal to manage projects for a user
        async function showManageProjectsModal(userId) {
            currentEditingUserId = userId;
            const modal = document.getElementById('manageProjectsModal');
            const projectListDiv = document.getElementById('projectSelectionList');
            const title = document.getElementById('manageProjectsTitle');
            
            // Find user data from the globally stored list
            const user = window.allUsersData ? window.allUsersData.find(u => u.id === userId) : null;
            const username = user ? (user.fullName || user.username) : 'User';
            title.textContent = `Manage Projects for ${username}`;
            
            projectListDiv.innerHTML = '<p>Loading projects...</p>';
            modal.style.display = 'flex';

            try {
                // Fetch all projects list
                const allProjectsResponse = await fetch(`${CONFIG.baseUrl}/api/all-projects`, { 
                    credentials: 'include' 
                });
                if (!allProjectsResponse.ok) throw new Error('Failed to fetch projects list');
                const allProjectsData = await allProjectsResponse.json();

                // Get the current user's assigned project IDs from the stored data
                const userProjectIds = user ? (user.projectIds || []) : [];

                if (allProjectsData.success && allProjectsData.projects) {
                    projectListDiv.innerHTML = ''; // Clear loading message
                    if (allProjectsData.projects.length === 0) {
                         projectListDiv.innerHTML = '<p>No projects available to assign.</p>';
                    }
                    allProjectsData.projects.forEach(project => {
                        const checkboxDiv = document.createElement('div');
                        checkboxDiv.className = 'project-checkbox-item';
                        const checkboxId = `project-${project.id}`;
                        checkboxDiv.innerHTML = `
                            <input type="checkbox" id="${checkboxId}" value="${project.id}" 
                                   ${userProjectIds.includes(project.id) ? 'checked' : ''}>
                            <label for="${checkboxId}">${project.name}</label>
                        `;
                        projectListDiv.appendChild(checkboxDiv);
                    });
                } else {
                    projectListDiv.innerHTML = `<p class="error-message">Failed to load project data: ${allProjectsData.error || 'Unknown error'}</p>`;
                }

            } catch (error) {
                console.error('Error loading project data for modal:', error);
                projectListDiv.innerHTML = `<p class="error-message">Error loading projects: ${error.message}</p>`;
            }
        }

        // Close the manage projects modal
        function closeManageProjectsModal() {
            const modal = document.getElementById('manageProjectsModal');
            modal.style.display = 'none';
            currentEditingUserId = null; // Clear the user ID
        }

        // Save the selected projects for the user
        async function saveUserProjects() {
            if (!currentEditingUserId) return;

            const projectListDiv = document.getElementById('projectSelectionList');
            const checkboxes = projectListDiv.querySelectorAll('input[type="checkbox"]:checked');
            const selectedProjectIds = Array.from(checkboxes).map(cb => cb.value);

            // console.log(`Saving projects for user ${currentEditingUserId}:`, selectedProjectIds); // Keep for debugging if needed

            try {
                // Call the PUT endpoint to save project IDs
                const response = await fetch(`${CONFIG.baseUrl}/api/users/${currentEditingUserId}/projects`, {
                    method: 'PUT',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ projectIds: selectedProjectIds })
                });

                const data = await response.json();

                if (data.success) {
                    showNotification('User project access updated successfully', 'success');
                    closeManageProjectsModal();
                    // Reload user list to show updated project info
                    loadUsers(); 
                } else {
                    showNotification(data.error || 'Failed to update project access', 'error');
                }
            } catch (error) {
                console.error('Error saving user projects:', error);
                showNotification('Failed to update project access', 'error');
            }
        }

        // --- End Project Management Functions ---

        function showForgotPasswordForm() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('forgotPasswordForm').style.display = 'block';
            document.getElementById('resetPasswordForm').style.display = 'none';
            document.querySelector('.auth-toggle').style.display = 'none';
            // Update active states
            document.querySelectorAll('.auth-toggle-btn').forEach(btn => {
                btn.classList.remove('active');
            });
        }

        function showLoginForm() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('forgotPasswordForm').style.display = 'none';
            document.getElementById('resetPasswordForm').style.display = 'none';
            document.getElementById('registerError').innerText = '';
            document.getElementById('registerError').style.display = 'none';
            document.querySelector('.auth-toggle').style.display = '';
            // Update active states
            document.querySelector('.auth-toggle-btn[data-target="loginForm"]').classList.add('active');
        }

        function showRegisterForm() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
            document.getElementById('forgotPasswordForm').style.display = 'none';
            document.getElementById('resetPasswordForm').style.display = 'none';
            document.getElementById('registerError').innerText = '';
            document.getElementById('registerError').style.display = 'none';
            document.querySelector('.auth-toggle').style.display = '';
            // Update active states
            document.querySelectorAll('.auth-toggle-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector('.auth-toggle-btn[data-target="registerForm"]').classList.add('active');
        }

        async function handleForgotPassword(event) {
            event.preventDefault();
            document.getElementById('forgotPasswordError').innerText = '';
            const email = document.getElementById('forgotPasswordEmail').value;
            try {
                const response = await fetch(`${CONFIG.baseUrl}/api/forgot-password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email })
                });
                const data = await response.json();
                if (data.success) {
                    document.getElementById('forgotPasswordError').style.color = '#15803d';
                    document.getElementById('forgotPasswordError').innerText = 'Password reset instructions sent to your email';
                    setTimeout(showLoginForm, 2000);
                } else {
                    document.getElementById('forgotPasswordError').style.color = '#b91c1c';
                    document.getElementById('forgotPasswordError').innerText = data.message || 'Failed to process password reset request';
                }
            } catch (error) {
                document.getElementById('forgotPasswordError').style.color = '#b91c1c';
                document.getElementById('forgotPasswordError').innerText = 'Failed to process password reset request';
            }
        }

        async function handleResetPassword(event) {
            event.preventDefault();
            removeLoginError();
            
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            
            if (newPassword !== confirmPassword) {
                showLoginError('Passwords do not match');
                return;
            }
            
            try {
                const response = await fetch(`${CONFIG.baseUrl}/api/reset-password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ token, newPassword })
                });
                
                const data = await response.json();
                if (data.success) {
                    showNotification('Password has been reset successfully', 'success');
                    showLoginForm();
                } else {
                    showLoginError(data.message || 'Failed to reset password');
                }
            } catch (error) {
                console.error('Reset password error:', error);
                showLoginError('Failed to reset password');
            }
        }

        // Check for reset token in URL on page load
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            
            if (token) {
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('registerForm').style.display = 'none';
                document.getElementById('forgotPasswordForm').style.display = 'none';
                document.getElementById('resetPasswordForm').style.display = 'block';
            }
        });

        // Modal dƒ±≈üƒ±na tƒ±klayƒ±nca kapatma √∂zelliƒüi
        function setupModalBackgroundClose() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('mousedown', function(e) {
                    if (e.target === modal) {
                        modal.style.display = 'none';
                    }
                });
            });
        }

        function handleJiraDrop(event) {
            event.preventDefault();
            document.getElementById('jiraUploadArea').classList.remove('dragover');
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                document.getElementById('appFile').files = files;
                handleJiraFileChange({ target: { files } });
            }
        }
        function handleJiraFileChange(event) {
            const file = event.target.files[0];
            const infoDiv = document.getElementById('jiraFileInfo');
            if (file) {
                const size = (file.size / 1024 / 1024).toFixed(2) + ' MB';
                infoDiv.innerHTML = `<div class='jira-file-row'><span class='jira-file-name'>${file.name}</span> <span class='jira-file-size'>(${size})</span> <button type='button' class='jira-remove-btn' onclick='removeJiraFile()'>Remove</button></div>`;
                infoDiv.style.display = '';
                document.getElementById('jiraUploadText').style.display = 'none';
            } else {
                infoDiv.innerHTML = '';
                infoDiv.style.display = 'none';
                document.getElementById('jiraUploadText').style.display = '';
            }
        }
        function removeJiraFile() {
            const input = document.getElementById('appFile');
            input.value = '';
            handleJiraFileChange({ target: { files: [] } });
        }

        // Large File Modal Functions
        function showLargeFileModal(fileSizeMB, formData, submitButton, originalContent) {
            document.getElementById('largeFileSize').textContent = `${fileSizeMB.toFixed(2)} MB`;
            document.getElementById('largeFileModal').style.display = 'flex';
            
            // Store upload data for later use
            pendingUploadData = {
                formData: formData,
                submitButton: submitButton,
                originalContent: originalContent
            };
        }

        function closeLargeFileModal() {
            document.getElementById('largeFileModal').style.display = 'none';
            
            // Reset button if upload was cancelled
            if (pendingUploadData) {
                pendingUploadData.submitButton.innerHTML = pendingUploadData.originalContent;
                pendingUploadData.submitButton.disabled = false;
                pendingUploadData = null;
            }
        }

        async function continueLargeFileUpload() {
            if (!pendingUploadData) return;
            
            closeLargeFileModal();
            
            const { formData, submitButton, originalContent } = pendingUploadData;
            pendingUploadData = null;
            
            // Get the file from formData
            const file = formData.get('file');
            if (!file) {
                showUploadError('No file found');
                submitButton.innerHTML = originalContent;
                submitButton.disabled = false;
                return;
            }
            
            // For large files, use chunked upload
            if (file.size > 20 * 1024 * 1024) { // 20MB
                await uploadLargeFileInChunks(file, formData, submitButton, originalContent);
            } else {
                // For smaller files, use normal upload
                await uploadFileNormally(formData, submitButton, originalContent);
            }
        }
        
        async function uploadLargeFileInChunks(file, formData, submitButton, originalContent) {
            const chunkSize = 5 * 1024 * 1024; // 5MB chunks
            const totalChunks = Math.ceil(file.size / chunkSize);
            let uploadedChunks = 0;
            
            try {
                // Update progress text
                const progressText = submitButton.querySelector('.progress-text');
                if (progressText) {
                    progressText.textContent = `Preparing to upload ${totalChunks} chunks...`;
                }
                
                for (let i = 0; i < totalChunks; i++) {
                    const start = i * chunkSize;
                    const end = Math.min(start + chunkSize, file.size);
                    const chunk = file.slice(start, end);
                    
                    // Create new FormData for this chunk
                    const chunkFormData = new FormData();
                    
                    // Add all the original form fields
                    for (let [key, value] of formData.entries()) {
                        if (key !== 'file') {
                            chunkFormData.append(key, value);
                        }
                    }
                    
                    // Add the chunk as a file
                    const chunkFile = new File([chunk], file.name, { type: file.type });
                    chunkFormData.append('file', chunkFile);
                    chunkFormData.append('chunkIndex', i.toString());
                    chunkFormData.append('totalChunks', totalChunks.toString());
                    chunkFormData.append('originalFileName', file.name);
                    chunkFormData.append('originalFileSize', file.size.toString());
                    
                    // Update progress
                    if (progressText) {
                        progressText.textContent = `Uploading chunk ${i + 1}/${totalChunks}...`;
                    }
                    
                    // Upload this chunk
                    const response = await fetch(`${CONFIG.baseUrl}/api/upload-chunk`, {
                        method: 'POST',
                        credentials: 'include',
                        body: chunkFormData
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Chunk ${i + 1} upload failed: ${response.status} ${response.statusText}`);
                    }
                    
                    uploadedChunks++;
                    
                    // Update progress
                    const progress = Math.round((uploadedChunks / totalChunks) * 100);
                    if (progressText) {
                        progressText.textContent = `Uploaded ${uploadedChunks}/${totalChunks} chunks (${progress}%)`;
                    }
                }
                
                // All chunks uploaded successfully
                showNotification(`Large file successfully uploaded in ${totalChunks} chunks`, 'success');
                closeModal('uploadModal');
                showAllApps();
                submitButton.innerHTML = originalContent;
                submitButton.disabled = false;
                
            } catch (error) {
                console.error('Chunked upload error:', error);
                showUploadError('Chunked upload failed: ' + error.message);
                submitButton.innerHTML = originalContent;
                submitButton.disabled = false;
            }
        }
        
        async function uploadFileNormally(formData, submitButton, originalContent) {
            try {
                // Create AbortController for timeout handling
                const controller = new AbortController();
                const timeoutId = setTimeout(() => {
                    controller.abort();
                }, 60 * 60 * 1000); // 60 minutes timeout for large files

                const response = await fetch(`${CONFIG.baseUrl}/api/upload`, {
                    method: 'POST',
                    credentials: 'include',
                    body: formData,
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                // Handle server-sent events (same as original upload)
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || '';
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                
                                if (data.type === 'connection') {
                                    console.log('Upload connection established');
                                }
                                
                                if (data.type === 'fileInfo') {
                                    console.log(`File size: ${(data.fileSize / 1024 / 1024).toFixed(2)} MB`);
                                }
                                
                                if (data.type === 'info') {
                                    console.log(data.message);
                                    const progressText = submitButton.querySelector('.progress-text');
                                    if (progressText) {
                                        progressText.textContent = data.message;
                                    }
                                }
                                
                                if (data.type === 'progress' && data.progress) {
                                    const progressText = submitButton.querySelector('.progress-text');
                                    if (progressText) {
                                        const uploadedMB = (data.uploadedBytes / 1024 / 1024).toFixed(2);
                                        const totalMB = (data.fileSize / 1024 / 1024).toFixed(2);
                                        progressText.textContent = `Uploading: ${Math.round(data.progress)}% (${uploadedMB}MB / ${totalMB}MB)`;
                                    }
                                }
                                
                                if (data.type === 'complete' && data.success) {
                                    if (data.totalParts && data.totalParts > 1) {
                                        showNotification(`Large file successfully uploaded in ${data.totalParts} parts`, 'success');
                                    } else {
                                        showNotification('File uploaded successfully', 'success');
                                    }
                                    closeModal('uploadModal');
                                    showAllApps();
                                    submitButton.innerHTML = originalContent;
                                    submitButton.disabled = false;
                                    return;
                                }
                                
                                if (data.error) {
                                    showUploadError(data.error);
                                    submitButton.innerHTML = originalContent;
                                    submitButton.disabled = false;
                                    return;
                                }
                                
                            } catch (parseError) {
                                console.error('Error parsing SSE data:', parseError, line);
                            }
                        }
                    }
                }
                
            } catch (error) {
                console.error('Upload error:', error);
                showUploadError('Upload failed: ' + error.message);
                submitButton.innerHTML = originalContent;
                submitButton.disabled = false;
            }
        }

        // Service Worker Registration for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js')
                    .then(function(registration) {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(function(err) {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }

        // PWA Install Prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevent Chrome 67 and earlier from automatically showing the prompt
            e.preventDefault();
            // Stash the event so it can be triggered later
            deferredPrompt = e;
            // Show install button (you can add this to your UI)
            showInstallButton();
        });

        function showInstallButton() {
            // You can add an install button to your UI here
            const installButton = document.createElement('button');
            installButton.textContent = 'Install App';
            installButton.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background-color: #6366f1;
                color: white;
                border: none;
                padding: 12px 20px;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 500;
                z-index: 1000;
                box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            `;
            installButton.addEventListener('click', () => {
                installButton.style.display = 'none';
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted the A2HS prompt');
                    } else {
                        console.log('User dismissed the A2HS prompt');
                    }
                    deferredPrompt = null;
                });
            });
            document.body.appendChild(installButton);
        }
    </script>
</body>
</html>