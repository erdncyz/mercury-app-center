<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mercury App Center</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" href="mercury-icon.png" type="image/png">
</head>
<body>
    <div id="loginContainer">
        <div class="login-box">
            <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%236366f1'%3E%3Cpath d='M12 2c-4.4 0-8 3.6-8 8s3.6 8 8 8 8-3.6 8-8-3.6-8-8-8zm0 14c-3.3 0-6-2.7-6-6s2.7-6 6-6 6 2.7 6 6-2.7 6-6 6z'/%3E%3Ccircle cx='12' cy='8' r='2'/%3E%3Crect x='11' y='10' width='2' height='6'/%3E%3Crect x='11' y='16' width='2' height='2'/%3E%3C/svg%3E" alt="Mercury Icon" class="login-icon">
            <h2>Mercury App Center</h2>
            <div class="auth-toggle">
                <button class="auth-toggle-btn active" data-target="loginForm">Login</button>
                <button class="auth-toggle-btn" data-target="registerForm">Register</button>
            </div>
            <form id="loginForm" onsubmit="handleLogin(event)">
                <input type="text" id="username" placeholder="Username" required>
                <input type="password" id="password" placeholder="Password" required>
                <button type="submit">Login</button>
            </form>
            <form id="registerForm" style="display: none;" onsubmit="handleRegister(event)">
                <input type="text" id="registerUsername" placeholder="Username" required>
                <input type="password" id="registerPassword" placeholder="Password" required>
                <input type="email" id="registerEmail" placeholder="Email">
                <input type="text" id="registerFullName" placeholder="Full Name">
                <button type="submit">Register</button>
            </form>
        </div>
        <div class="background-icons"></div>
    </div>

    <div id="mainContainer" style="display: none;">
        <header>
            <div class="header-left">
                <img src="mercury-icon.png" alt="Mercury Icon" class="header-icon">
                <h1>Mercury App Center</h1>
            </div>
            <div class="header-right">
                <span id="userDisplay"></span>
                <button id="adminPanelButton" style="display: none;" onclick="showAdminPanel()">Admin Panel</button>
                <button onclick="handleLogout()">Logout</button>
            </div>
        </header>

        <main>
            <div class="search-bar">
                <input type="text" id="searchInput" placeholder="Search apps..." oninput="filterUploads()">
                <select id="osFilter" onchange="filterUploads()">
                    <option value="all">All OS</option>
                    <option value="ios">iOS</option>
                    <option value="android">Android</option>
                    <option value="tvos">Apple TV</option>
                    <option value="androidtv">Android TV</option>
                </select>
            </div>

            <div class="create-project">
                <button onclick="showCreateProjectModal()">Create New Project</button>
            </div>

            <div id="allApps"></div>

            <div id="createProjectModal" class="modal">
                <div class="modal-content">
                    <div class="modal-close" onclick="closeModal('createProjectModal')"></div>
                    <h2>Create New Project</h2>
                    <form id="createProjectForm">
                        <div class="form-group">
                            <label>Project Name</label>
                            <input type="text" id="projectNameInput" required>
                        </div>
                        <div class="modal-actions">
                            <button type="button" class="cancel-btn" onclick="closeModal('createProjectModal')">Cancel</button>
                            <button type="submit" class="create-btn">Create</button>
                        </div>
                    </form>
                </div>
            </div>

            <div id="uploadModal" class="modal">
                <div class="modal-content">
                    <div class="modal-close" onclick="closeModal('uploadModal')"></div>
                    <div class="upload-modal-header">
                        <h2>Upload New Version</h2>
                        <div class="project-name" id="uploadProjectName"></div>
                    </div>
                    <form id="uploadForm">
                        <input type="hidden" id="projectIdInput" name="projectId">
                        <div class="form-group">
                            <label>Platform</label>
                            <select id="platformSelect" name="platform" required>
                                <option value="ios">iOS</option>
                                <option value="android">Android</option>
                                <option value="tvos">Apple TV</option>
                                <option value="androidtv">Android TV</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Version</label>
                            <input type="text" id="versionInput" name="version" required placeholder="1.0.0">
                        </div>
                        <div class="form-group">
                            <label>Test Notes</label>
                            <textarea id="testNotes" name="notes" rows="4"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Environment</label>
                            <select id="environmentSelect" name="environment" required>
                                <option value="production">Production (Market)</option>
                                <option value="test">Test</option>
                                <option value="regression">Regression</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>App File</label>
                            <input type="file" id="appFile" name="file" required>
                        </div>
                        <div class="modal-actions">
                            <button type="button" class="cancel-btn" onclick="closeModal('uploadModal')">Cancel</button>
                            <button type="submit" class="create-btn">Upload</button>
                        </div>
                    </form>
                </div>
            </div>

            <div id="usersAdminModal" class="modal">
                <div class="modal-content">
                    <div class="modal-close" onclick="closeModal('usersAdminModal')"></div>
                    <h2>User Management</h2>
                    <p>Approve or reject pending user registrations</p>
                    <div id="usersList"></div>
                    <div class="modal-actions">
                        <button type="button" class="cancel-btn" onclick="closeModal('usersAdminModal')">Close</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const CONFIG = {
            baseUrl: `http://${location.hostname}:${location.port || 3000}`
        };

        let currentPage = 1;
        const itemsPerPage = 10;
        let allVersions = [];
        let filteredVersions = [];
        
        // Enhance touch interactions for mobile
        function enhanceTouchExperience() {
            const isMobile = window.matchMedia('(max-width: 768px)').matches;
            
            if (isMobile) {
                // Add touch delay to prevent accidental taps
                document.querySelectorAll('button, .app-card, .version-item').forEach(element => {
                    element.addEventListener('touchstart', function() {
                        this.classList.add('touch-active');
                    });
                    
                    element.addEventListener('touchend', function() {
                        this.classList.remove('touch-active');
                    });
                    
                    element.addEventListener('touchcancel', function() {
                        this.classList.remove('touch-active');
                    });
                });
                
                // Add better scrolling for modals on mobile
                document.querySelectorAll('.modal-content').forEach(modal => {
                    modal.addEventListener('touchmove', function(e) {
                        e.stopPropagation();
                    });
                });
            }
        }

        // When document is ready
        document.addEventListener('DOMContentLoaded', async function() {
            // Set auth toggle event listeners
            document.querySelectorAll('.auth-toggle-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const targetForm = this.dataset.target;
                    
                    // Hide all forms
                    document.getElementById('loginForm').style.display = 'none';
                    document.getElementById('registerForm').style.display = 'none';
                    
                    // Show selected form
                    document.getElementById(targetForm).style.display = 'block';
                    
                    // Update active states
                    document.querySelectorAll('.auth-toggle-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    this.classList.add('active');
                });
            });
            
            if (localStorage.getItem('isLoggedIn') === 'true') {
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('mainContainer').style.display = 'block';
                updateUsername();
                showAllApps();
            }
            
            await checkLoginStatus();
        });
        
        // Update enhanceTouchExperience on resize
        window.addEventListener('resize', function() {
            enhanceTouchExperience();
        });
        
        // Prevent zooming on double-tap for iOS Safari
        document.addEventListener('touchstart', function(event) {
            if (event.touches.length > 1) {
                event.preventDefault();
            }
        }, { passive: false });
        
        // Code to initialize touch active style
        document.head.insertAdjacentHTML('beforeend', `
            <style>
                .touch-active {
                    opacity: 0.7;
                    transition: opacity 0.2s;
                }
            </style>
        `);

        async function handleLogin(event) {
            event.preventDefault();
            removeLoginError();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                const response = await fetch(`${CONFIG.baseUrl}/login`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();
                if (data.success) {
                    localStorage.setItem('isLoggedIn', 'true');
                    localStorage.setItem('username', data.user.username);
                    localStorage.setItem('userRole', data.user.role);
                    document.getElementById('loginContainer').style.display = 'none';
                    document.getElementById('mainContainer').style.display = 'block';
                    updateUsername();
                    await checkAdminStatus();
                    await updateUserPermissions();
                    showAllApps();
                } else {
                    showLoginError(data.message || data.error || 'Invalid username or password');
                }
            } catch (error) {
                console.error('Login error:', error);
                showLoginError('Login failed. Please try again.');
            }
        }

        function showLoginError(message) {
            // Önce varolan hata mesajını temizle
            removeLoginError();
            
            const loginForm = document.getElementById('loginForm');
            const submitButton = loginForm.querySelector('button[type="submit"]');
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'login-error';
            
            const errorIcon = document.createElement('div');
            errorIcon.className = 'login-error-icon';
            errorIcon.innerHTML = `
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                          d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
            `;
            
            const errorMessage = document.createElement('span');
            errorMessage.textContent = message;
            
            errorDiv.appendChild(errorIcon);
            errorDiv.appendChild(errorMessage);
            
            // Hata mesajını login butonundan önce ekle
            loginForm.insertBefore(errorDiv, submitButton);
        }

        function removeLoginError() {
            const existingError = document.querySelector('.login-error');
            if (existingError) {
                existingError.remove();
            }
        }

        async function handleLogout() {
            try {
                const response = await fetch(`${CONFIG.baseUrl}/logout`, {
                    method: 'POST',
                    credentials: 'include'
                });

                const data = await response.json();
                if (data.success) {
                    localStorage.removeItem('isLoggedIn');
                    localStorage.removeItem('username');
                    localStorage.removeItem('userRole');
                    document.getElementById('loginContainer').style.display = 'block';
                    document.getElementById('mainContainer').style.display = 'none';
                    showNotification('Logged out successfully', 'success');
                }
            } catch (error) {
                console.error('Logout error:', error);
                showNotification('Logout failed', 'error');
            }
        }

        function updateUsername() {
            const username = localStorage.getItem('username');
            if (username) {
                document.getElementById('userDisplay').textContent = `Welcome, ${username}`;
            }
        }

        async function checkLoginStatus() {
            try {
                const response = await fetch(`${CONFIG.baseUrl}/api/check-session`, {
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (data.isLoggedIn) {
                    localStorage.setItem('isLoggedIn', 'true');
                    localStorage.setItem('username', data.username);
                    localStorage.setItem('userRole', data.userRole);
                    document.getElementById('loginContainer').style.display = 'none';
                    document.getElementById('mainContainer').style.display = 'block';
                    updateUsername();
                    await checkAdminStatus();
                    await updateUserPermissions();
                } else {
                    localStorage.removeItem('isLoggedIn');
                    localStorage.removeItem('username');
                    localStorage.removeItem('userRole');
                    document.getElementById('loginContainer').style.display = 'block';
                    document.getElementById('mainContainer').style.display = 'none';
                }
            } catch (error) {
                console.error('Login status check error:', error);
                document.getElementById('loginContainer').style.display = 'block';
                document.getElementById('mainContainer').style.display = 'none';
            }
        }

        function showCreateProjectModal() {
            const modal = document.getElementById('createProjectModal');
            modal.style.display = 'flex';
            document.getElementById('createProjectForm').reset();
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.style.display = 'none';
        }

        document.getElementById('createProjectForm').addEventListener('submit', async (event) => {
            event.preventDefault();
            
            const projectName = document.getElementById('projectNameInput').value;
            
            try {
                const response = await fetch(`${CONFIG.baseUrl}/api/projects`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name: projectName })
                });

                const data = await response.json();
                if (data.success) {
                    showNotification('Project created successfully', 'success');
                    closeModal('createProjectModal');
                    showAllApps();
                } else {
                    showNotification(data.error || 'Failed to create project', 'error');
                }
            } catch (error) {
                console.error('Project creation error:', error);
                showNotification('Failed to create project', 'error');
            }
        });

        async function showAllApps(page = 1) {
            try {
                const response = await fetch(`${CONFIG.baseUrl}/api/projects?page=${page}&limit=10`, {
                    credentials: 'include'
                });
                const data = await response.json();
                
                const container = document.getElementById('allApps');
                
                if (page === 1) {
                    container.innerHTML = '';
                }

                data.projects.forEach(project => {
                    const card = document.createElement('div');
                    card.className = 'app-card';
                    card.setAttribute('onclick', 'toggleProject(event, this)');
                    
                    // Versiyonları unique hale getir
                    const uniqueVersions = project.versions ? project.versions.reduce((acc, current) => {
                        const x = acc.find(item => item.version === current.version && item.platform === current.platform);
                        if (!x) {
                            return acc.concat([current]);
                        } else {
                            // Eğer aynı versiyon varsa, daha yeni olanı kullan
                            if (new Date(current.uploadedAt) > new Date(x.uploadedAt)) {
                                const index = acc.indexOf(x);
                                acc[index] = current;
                            }
                            return acc;
                        }
                    }, []) : [];

                    // Versiyonları tarihe göre sırala (en yeni en üstte)
                    uniqueVersions.sort((a, b) => new Date(b.uploadedAt) - new Date(a.uploadedAt));

                    const platforms = {
                        ios: uniqueVersions.filter(v => v.platform === 'ios'),
                        android: uniqueVersions.filter(v => v.platform === 'android'),
                        tvos: uniqueVersions.filter(v => v.platform === 'tvos'),
                        androidtv: uniqueVersions.filter(v => v.platform === 'androidtv')
                    };
                    
                    card.innerHTML = `
                        <div class="app-header">
                            <div class="app-title">${project.name}</div>
                            <div class="app-actions">
                                <button onclick="event.stopPropagation(); showUploadModal('${project.id}', '${project.name}')">
                                    <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                                    </svg>
                                    Upload .ipa/.apk/.app
                                </button>
                                <button onclick="event.stopPropagation(); deleteProject('${project.id}')">
                                    <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                    </svg>
                                    Delete
                                </button>
                            </div>
                        </div>
                        <div class="platform-container">
                            ${platforms.ios.length > 0 ? `
                                <div class="platform-item">
                                    <div class="platform-header">
                                        <span>🍎 iOS</span>
                                    </div>
                                    ${platforms.ios.map(version => `
                                        <div class="version-item" onclick="toggleVersion(event, this)">
                                            <div class="version-header">
                                                <div class="version-title">
                                                    <span class="version-number">v${version.version || 'N/A'}</span>
                                                    <span class="version-environment ${version.environment || 'undefined'}">${getEnvironmentLabel(version.environment)}</span>
                                                    <span class="version-date">${new Date(version.uploadedAt).toLocaleString()}</span>
                                                </div>
                                                <div class="version-toggle">▼</div>
                                            </div>
                                            <div class="version-content">
                                                <div class="version-info">
                                                    <div class="version-uploader">Uploaded by: ${version.uploadedBy || 'Unknown'}</div>
                                                    <div class="version-environment-info">
                                                        <span class="environment-label">Environment:</span>
                                                        <span class="environment-value ${version.environment || 'undefined'}">${getEnvironmentLabel(version.environment)}</span>
                                                    </div>
                                                    <div class="version-notes">${version.notes || 'No notes'}</div>
                                                </div>
                                                <div class="version-actions">
                                                    <button ontouchstart="" onclick="event.stopPropagation(); downloadVersion('${project.id}', '${version.id}')">
                                                        <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                                                        </svg>
                                                        Download
                                                    </button>
                                                    <button onclick="event.stopPropagation(); deleteVersion('${project.id}', '${version.id}')">
                                                        <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                                        </svg>
                                                        Delete
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                            ${platforms.android.length > 0 ? `
                                <div class="platform-item">
                                    <div class="platform-header">
                                        <span>🤖 Android</span>
                                    </div>
                                    ${platforms.android.map(version => `
                                        <div class="version-item" onclick="toggleVersion(event, this)">
                                            <div class="version-header">
                                                <div class="version-title">
                                                    <span class="version-number">v${version.version || 'N/A'}</span>
                                                    <span class="version-environment ${version.environment || 'undefined'}">${getEnvironmentLabel(version.environment)}</span>
                                                    <span class="version-date">${new Date(version.uploadedAt).toLocaleString()}</span>
                                                </div>
                                                <div class="version-toggle">▼</div>
                                            </div>
                                            <div class="version-content">
                                                <div class="version-info">
                                                    <div class="version-uploader">Uploaded by: ${version.uploadedBy || 'Unknown'}</div>
                                                    <div class="version-environment-info">
                                                        <span class="environment-label">Environment:</span>
                                                        <span class="environment-value ${version.environment || 'undefined'}">${getEnvironmentLabel(version.environment)}</span>
                                                    </div>
                                                    <div class="version-notes">${version.notes || 'No notes'}</div>
                                                </div>
                                                <div class="version-actions">
                                                    <button ontouchstart="" onclick="event.stopPropagation(); downloadVersion('${project.id}', '${version.id}')">
                                                        <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                                                        </svg>
                                                        Download
                                                    </button>
                                                    <button onclick="event.stopPropagation(); deleteVersion('${project.id}', '${version.id}')">
                                                        <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                                        </svg>
                                                        Delete
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                            ${platforms.tvos.length > 0 ? `
                                <div class="platform-item">
                                    <div class="platform-header">
                                        <span>📺 Apple TV</span>
                                    </div>
                                    ${platforms.tvos.map(version => `
                                        <div class="version-item" onclick="toggleVersion(event, this)">
                                            <div class="version-header">
                                                <div class="version-title">
                                                    <span class="version-number">v${version.version || 'N/A'}</span>
                                                    <span class="version-environment ${version.environment || 'undefined'}">${getEnvironmentLabel(version.environment)}</span>
                                                    <span class="version-date">${new Date(version.uploadedAt).toLocaleString()}</span>
                                                </div>
                                                <div class="version-toggle">▼</div>
                                            </div>
                                            <div class="version-content">
                                                <div class="version-info">
                                                    <div class="version-uploader">Uploaded by: ${version.uploadedBy || 'Unknown'}</div>
                                                    <div class="version-environment-info">
                                                        <span class="environment-label">Environment:</span>
                                                        <span class="environment-value ${version.environment || 'undefined'}">${getEnvironmentLabel(version.environment)}</span>
                                                    </div>
                                                    <div class="version-notes">${version.notes || 'No notes'}</div>
                                                </div>
                                                <div class="version-actions">
                                                    <button ontouchstart="" onclick="event.stopPropagation(); downloadVersion('${project.id}', '${version.id}')">
                                                        <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                                                        </svg>
                                                        Download
                                                    </button>
                                                    <button onclick="event.stopPropagation(); deleteVersion('${project.id}', '${version.id}')">
                                                        <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                                        </svg>
                                                        Delete
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                            ${platforms.androidtv.length > 0 ? `
                                <div class="platform-item">
                                    <div class="platform-header">
                                        <span>📺 Android TV</span>
                                    </div>
                                    ${platforms.androidtv.map(version => `
                                        <div class="version-item" onclick="toggleVersion(event, this)">
                                            <div class="version-header">
                                                <div class="version-title">
                                                    <span class="version-number">v${version.version || 'N/A'}</span>
                                                    <span class="version-environment ${version.environment || 'undefined'}">${getEnvironmentLabel(version.environment)}</span>
                                                    <span class="version-date">${new Date(version.uploadedAt).toLocaleString()}</span>
                                                </div>
                                                <div class="version-toggle">▼</div>
                                            </div>
                                            <div class="version-content">
                                                <div class="version-info">
                                                    <div class="version-uploader">Uploaded by: ${version.uploadedBy || 'Unknown'}</div>
                                                    <div class="version-environment-info">
                                                        <span class="environment-label">Environment:</span>
                                                        <span class="environment-value ${version.environment || 'undefined'}">${getEnvironmentLabel(version.environment)}</span>
                                                    </div>
                                                    <div class="version-notes">${version.notes || 'No notes'}</div>
                                                </div>
                                                <div class="version-actions">
                                                    <button ontouchstart="" onclick="event.stopPropagation(); downloadVersion('${project.id}', '${version.id}')">
                                                        <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                                                        </svg>
                                                        Download
                                                    </button>
                                                    <button onclick="event.stopPropagation(); deleteVersion('${project.id}', '${version.id}')">
                                                        <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                                        </svg>
                                                        Delete
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                            ${(!platforms.ios.length && !platforms.android.length && !platforms.tvos.length && !platforms.androidtv.length) ? `
                                <div class="empty-platform-message">
                                    <p>No versions uploaded yet</p>
                                </div>
                            ` : ''}
                        </div>
                    `;
                    
                    container.appendChild(card);
                });

                // Pagination controls eklendikten sonra, butonları güncelle
                updateActionButtons();
                
                // Sayfalama kontrollerini ekle
                if (data.totalPages > 1) {
                    const paginationDiv = document.createElement('div');
                    paginationDiv.className = 'pagination';
                    paginationDiv.innerHTML = `
                        ${data.currentPage > 1 ? 
                            `<button onclick="showAllApps(${data.currentPage - 1})">Previous</button>` : ''}
                        <span>Page ${data.currentPage} of ${data.totalPages}</span>
                        ${data.currentPage < data.totalPages ? 
                            `<button onclick="showAllApps(${data.currentPage + 1})">Next</button>` : ''}
                    `;
                    container.appendChild(paginationDiv);
                }
            } catch (error) {
                console.error('Error loading apps:', error);
                showNotification('Failed to load apps', 'error');
            }
        }

        async function deleteProject(projectId) {
            showConfirmDialog('Are you sure you want to delete this project?', async () => {
                try {
                    const response = await fetch(`${CONFIG.baseUrl}/api/projects/${projectId}`, {
                        method: 'DELETE',
                        credentials: 'include'
                    });

                    const data = await response.json();
                    if (data.success) {
                        showNotification('Project deleted successfully', 'success');
                        showAllApps();
                    } else {
                        showNotification(data.error || 'Failed to delete project', 'error');
                    }
                } catch (error) {
                    console.error('Delete error:', error);
                    showNotification('Failed to delete project', 'error');
                }
            }, 'project');
        }

        function showConfirmDialog(message, onConfirm, type = 'project') {
            const backdrop = document.createElement('div');
            backdrop.className = 'confirm-dialog-backdrop';
            
            const dialog = document.createElement('div');
            dialog.className = 'confirm-dialog';
            dialog.innerHTML = `
                <h3>Delete ${type === 'project' ? 'Project' : 'Version'}</h3>
                <p>${message}</p>
                <div class="confirm-dialog-actions">
                    <button class="confirm-dialog-cancel" onclick="closeConfirmDialog()">Cancel</button>
                    <button class="confirm-dialog-delete" onclick="handleConfirm()">Delete</button>
                </div>
            `;
            
            document.body.appendChild(backdrop);
            document.body.appendChild(dialog);
            
            // Arka plana tıklandığında dialogu kapat
            backdrop.addEventListener('click', (e) => {
                if (e.target === backdrop) {
                    closeConfirmDialog();
                }
            });
            
            // ESC tuşuna basıldığında dialogu kapat
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeConfirmDialog();
                }
            });
            
            window.handleConfirm = () => {
                onConfirm();
                closeConfirmDialog();
            };
        }
        
        function closeConfirmDialog() {
            const backdrop = document.querySelector('.confirm-dialog-backdrop');
            const dialog = document.querySelector('.confirm-dialog');
            if (backdrop) backdrop.remove();
            if (dialog) dialog.remove();
        }

        function showUploadModal(projectId, projectName) {
            const modal = document.getElementById('uploadModal');
            document.getElementById('projectIdInput').value = projectId;
            document.getElementById('uploadProjectName').textContent = `Project: ${projectName}`;
            modal.style.display = 'flex';
            document.getElementById('uploadForm').reset();
        }

        async function handleUpload(event) {
            event.preventDefault();
            
            const form = event.target;
            const formData = new FormData(form);
            
            // Environment değerini formData'ya ekleyelim
            const environment = document.getElementById('environmentSelect').value;
            formData.set('environment', environment);
            
            const projectId = document.getElementById('projectIdInput').value;
            
            // Upload error mesajını temizle
            removeUploadError();
            
            try {
                const response = await fetch(`${CONFIG.baseUrl}/api/upload`, {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                });

                const data = await response.json();
                
                if (data.success) {
                    showNotification('File uploaded successfully', 'success');
                    closeModal('uploadModal');
                    showAllApps();
                } else {
                    showUploadError(data.error || 'Failed to upload file');
                }
            } catch (error) {
                console.error('Upload error:', error);
                showUploadError('Failed to upload file');
            }
        }

        document.getElementById('uploadForm').addEventListener('submit', handleUpload);

        function showUploadError(message) {
            removeUploadError();
            
            const uploadForm = document.getElementById('uploadForm');
            const fileInput = document.getElementById('appFile');
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'upload-error';
            errorDiv.innerHTML = `
                <div class="upload-error-icon">
                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                              d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
                <span>${message}</span>
            `;
            
            fileInput.parentNode.insertBefore(errorDiv, fileInput.nextSibling);
        }

        function removeUploadError() {
            const existingError = document.querySelector('.upload-error');
            if (existingError) {
                existingError.remove();
            }
        }

        function showNotification(message, type = 'success') {
            // Create notification
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            notification.style.zIndex = '9999';
            
            // Add to body
            document.body.appendChild(notification);
            
            // Auto-remove after 3 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }

        async function downloadVersion(projectId, versionId) {
            try {
                // Get the button that was clicked
                const clickedButton = event.target.closest('button');
                
                // Disable the button and show loading state
                if (clickedButton) {
                    // Store original button content
                    const originalContent = clickedButton.innerHTML;
                    
                    // Update button appearance
                    clickedButton.disabled = true;
                    clickedButton.innerHTML = `
                        <svg class="animate-spin" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" stroke-dasharray="30 30" stroke-dashoffset="0"></circle>
                            <path fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Processing...
                    `;
                    
                    const response = await fetch(`${CONFIG.baseUrl}/api/download/${projectId}/${versionId}`, {
                        method: 'GET',
                        credentials: 'include'
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Failed to download file');
                    }

                    const blob = await response.blob();
                    
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = response.headers.get('Content-Disposition')?.split('filename=')[1]?.replace(/"/g, '') || 'download';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);

                    showNotification('Download started', 'success');
                    
                    // Restore button state after download completes
                    if (clickedButton) {
                        setTimeout(() => {
                            clickedButton.innerHTML = originalContent;
                            clickedButton.disabled = false;
                        }, 1000); // Short delay to ensure user sees the feedback
                    }
                } else {
                    // Fallback if button not found
                    const response = await fetch(`${CONFIG.baseUrl}/api/download/${projectId}/${versionId}`, {
                        method: 'GET',
                        credentials: 'include'
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Failed to download file');
                    }

                    const blob = await response.blob();
                    
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = response.headers.get('Content-Disposition')?.split('filename=')[1]?.replace(/"/g, '') || 'download';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);

                    showNotification('Download started', 'success');
                }
            } catch (error) {
                console.error('Download error:', error);
                showNotification(error.message, 'error');
                
                // If error occurs, also restore the button
                const clickedButton = event.target.closest('button');
                if (clickedButton) {
                    const defaultIcon = `<svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                    </svg>
                    Download`;
                    clickedButton.innerHTML = defaultIcon;
                    clickedButton.disabled = false;
                }
            }
        }

        function toggleProject(event, element) {
            if (event.target.closest('.app-actions') || 
                event.target.closest('.version-actions')) {
                return;
            }
            
            const wasActive = element.classList.contains('active');
            
            document.querySelectorAll('.app-card').forEach(card => {
                if (card !== element) {
                    card.classList.remove('active');
                }
            });
            
            element.classList.toggle('active', !wasActive);
        }

        function toggleVersion(event, element) {
            event.stopPropagation(); // Prevent project toggle
            
            const wasActive = element.classList.contains('active');
            
            // Aynı seviyedeki diğer versiyonları kapat
            const siblings = element.parentElement.querySelectorAll('.version-item');
            siblings.forEach(sibling => {
                if (sibling !== element) {
                    sibling.classList.remove('active');
                }
            });
            
            element.classList.toggle('active', !wasActive);
        }

        async function deleteVersion(projectId, versionId) {
            showConfirmDialog('Are you sure you want to delete this version?', async () => {
                try {
                    const response = await fetch(`${CONFIG.baseUrl}/api/projects/${projectId}/versions/${versionId}`, {
                        method: 'DELETE',
                        credentials: 'include',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    
                    if (data.success) {
                        showNotification('Version deleted successfully', 'success');
                        await showAllApps();
                        await showRecentUploads();
                    } else {
                        throw new Error(data.error || 'Failed to delete version');
                    }
                } catch (error) {
                    console.error('Delete version error:', error);
                    showNotification(error.message, 'error');
                } finally {
                    closeConfirmDialog();
                }
            }, 'version');
        }

        async function showRecentUploads() {
            try {
                const response = await fetch(`${CONFIG.baseUrl}/api/projects`, {
                    credentials: 'include'
                });
                const projects = await response.json();
                
                const fiveDaysAgo = new Date();
                fiveDaysAgo.setDate(fiveDaysAgo.getDate() - 5);
                
                allVersions = projects.reduce((versions, project) => {
                    const projectVersions = project.versions.map(version => ({
                        ...version,
                        projectName: project.name,
                        projectId: project.id
                    }));
                    return [...versions, ...projectVersions];
                }, []);
                
                allVersions = allVersions
                    .filter(version => new Date(version.uploadedAt) >= fiveDaysAgo)
                    .sort((a, b) => new Date(b.uploadedAt) - new Date(a.uploadedAt));

                localStorage.setItem('recentUploads', JSON.stringify(allVersions));

                filteredVersions = [];
                currentPage = 1;

                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                const osFilter = document.getElementById('osFilter').value;
                const typeFilter = document.getElementById('typeFilter').value;

                if (searchTerm || osFilter !== 'all' || typeFilter !== 'all') {
                    filterUploads();
                } else {
                    updateRecentUploadsList();
                }
            } catch (error) {
                console.error('Error loading recent uploads:', error);
            }
        }

        function filterUploads() {
            const searchText = document.getElementById('searchInput').value.toLowerCase();
            const osFilter = document.getElementById('osFilter').value;
            
            document.querySelectorAll('.app-card').forEach(card => {
                const title = card.querySelector('.app-title').textContent.toLowerCase();
                const hasMatchingVersion = Array.from(card.querySelectorAll('.platform-item')).some(platform => {
                    const platformType = platform.querySelector('.platform-header').textContent.toLowerCase();
                    return osFilter === 'all' || 
                           (osFilter === 'ios' && platformType.includes('ios')) ||
                           (osFilter === 'android' && platformType.includes('android') && !platformType.includes('tv')) ||
                           (osFilter === 'tvos' && platformType.includes('apple tv')) ||
                           (osFilter === 'androidtv' && platformType.includes('android tv'));
                });

                const matchesSearch = title.includes(searchText);
                card.style.display = (matchesSearch && (osFilter === 'all' || hasMatchingVersion)) ? 'block' : 'none';
            });
        }

        function updateRecentUploadsList() {
            const versionsToShow = filteredVersions.length > 0 ? filteredVersions : allVersions;
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const currentVersions = versionsToShow.slice(startIndex, endIndex);
            
            const container = document.getElementById('recentUploads');
            if (container) {
                container.innerHTML = currentVersions.map(version => `
                    <div class="version-card">
                        <div class="version-header">
                            <span class="project-name">${version.projectName}</span>
                            <span class="platform-badge ${version.platform}">${version.platform === 'ios' ? '🍎' : version.platform === 'android' ? '🤖' : version.platform === 'tvos' ? '📺' : '📺'} ${version.platform}</span>
                        </div>
                        <div class="version-details">
                            <div class="version-number">v${version.version}</div>
                            <div class="upload-time">${new Date(version.uploadedAt).toLocaleString()}</div>
                            <div class="uploader">Uploaded by: ${version.uploadedBy || 'Unknown'}</div>
                            <div class="notes">${version.notes}</div>
                        </div>
                    </div>
                `).join('');
            }
            
            updatePagination(versionsToShow.length);
        }

        function updatePagination(totalItems) {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const paginationContainer = document.getElementById('pagination');
            
            if (paginationContainer) {
                let paginationHTML = '';
                
                if (totalPages > 1) {
                    if (currentPage > 1) {
                        paginationHTML += `<button onclick="changePage(${currentPage - 1})">Previous</button>`;
                    }
                    
                    paginationHTML += `<span>Page ${currentPage}</span>`;
                    
                    if (currentPage < totalPages) {
                        paginationHTML += `<button onclick="changePage(${currentPage + 1})">Next</button>`;
                    }
                }
                
                paginationContainer.innerHTML = paginationHTML;
            }
        }

        function changePage(newPage) {
            currentPage = newPage;
            updateRecentUploadsList();
        }

        function getEnvironmentLabel(env) {
            const labels = {
                'production': '🚀 Market',
                'test': '🧪 Test',
                'regression': '🔄 Regression'
            };
            // If env value exists and is in labels, return it, otherwise return Unknown
            return env && labels[env] ? labels[env] : '❓ Unknown';
        }

        // Add Intersection Observer for lazy loading
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const versionList = entry.target;
                    loadVersions(versionList.dataset.projectId);
                    observer.unobserve(versionList);
                }
            });
        }, { threshold: 0.1 });

        function loadVersions(projectId) {
            const versionList = document.querySelector(`#versions-${projectId}`);
            if (!versionList.children.length) {
                // Versiyonları yükle
                // ... versiyon yükleme kodu ...
            }
        }

        // Versiyon yükleme fonksiyonunu güncelleyelim
        function loadVersionsForProject(project, container) {
            const platforms = {
                ios: project.versions?.filter(v => v.platform === 'ios').slice(0, 5) || [],
                android: project.versions?.filter(v => v.platform === 'android').slice(0, 5) || [],
                tvos: project.versions?.filter(v => v.platform === 'tvos').slice(0, 5) || [],
                androidtv: project.versions?.filter(v => v.platform === 'androidtv').slice(0, 5) || []
            };

            // Her platform için sadece son 5 versiyonu göster
            Object.entries(platforms).forEach(([platform, versions]) => {
                if (versions.length) {
                    const platformDiv = document.createElement('div');
                    platformDiv.className = 'platform-item';
                    // ... platform içeriği ...
                    
                    // "Show More" butonu ekle
                    if (project.versions.filter(v => v.platform === platform).length > 5) {
                        const showMoreBtn = document.createElement('button');
                        showMoreBtn.className = 'show-more-btn';
                        showMoreBtn.textContent = 'Show More';
                        showMoreBtn.onclick = () => loadMoreVersions(project.id, platform);
                        platformDiv.appendChild(showMoreBtn);
                    }
                    
                    container.appendChild(platformDiv);
                }
            });
        }

        // Handle user registration
        async function handleRegister(event) {
            event.preventDefault();
            removeLoginError();
            
            const username = document.getElementById('registerUsername').value;
            const password = document.getElementById('registerPassword').value;
            const email = document.getElementById('registerEmail').value;
            const fullName = document.getElementById('registerFullName').value;
            
            try {
                const response = await fetch(`${CONFIG.baseUrl}/api/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password, email, fullName })
                });
                
                const data = await response.json();
                if (data.success) {
                    showNotification('Registration successful. Your account is pending approval by an administrator.', 'success');
                    // Switch back to login form
                    document.querySelector('.auth-toggle-btn[data-target="loginForm"]').click();
                } else {
                    showLoginError(data.error || 'Registration failed');
                }
            } catch (error) {
                console.error('Registration error:', error);
                showLoginError('Registration failed. Please try again.');
            }
        }
        
        // Check if user is admin
        async function checkAdminStatus() {
            try {
                const response = await fetch(`${CONFIG.baseUrl}/api/check-admin`, {
                    credentials: 'include'
                });
                
                const data = await response.json();
                if (data.isAdmin) {
                    // Show admin panel button
                    document.getElementById('adminPanelButton').style.display = 'inline-block';
                } else {
                    document.getElementById('adminPanelButton').style.display = 'none';
                }
            } catch (error) {
                console.error('Admin check error:', error);
            }
        }
        
        // Show admin panel
        function showAdminPanel() {
            loadUsers();
            document.getElementById('usersAdminModal').style.display = 'flex';
        }
        
        // Load users for admin panel
        async function loadUsers() {
            try {
                const response = await fetch(`${CONFIG.baseUrl}/api/users`, {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error(`Error: ${response.status}`);
                }
                
                const data = await response.json();
                
                const usersList = document.getElementById('usersList');
                usersList.innerHTML = '';
                
                // Group users into pending and approved
                const pendingUsers = data.users.filter(user => !user.approved);
                const approvedUsers = data.users.filter(user => user.approved);
                
                // Show pending users first
                if (pendingUsers.length > 0) {
                    const pendingSection = document.createElement('div');
                    pendingSection.className = 'users-section';
                    pendingSection.innerHTML = '<h3>Pending Approval</h3>';
                    
                    pendingUsers.forEach(user => {
                        const userItem = createUserItem(user);
                        pendingSection.appendChild(userItem);
                    });
                    
                    usersList.appendChild(pendingSection);
                }
                
                // Then show approved users
                if (approvedUsers.length > 0) {
                    const approvedSection = document.createElement('div');
                    approvedSection.className = 'users-section';
                    approvedSection.innerHTML = '<h3>Approved Users</h3>';
                    
                    approvedUsers.forEach(user => {
                        const userItem = createUserItem(user);
                        approvedSection.appendChild(userItem);
                    });
                    
                    usersList.appendChild(approvedSection);
                }
                
                if (data.users.length === 0) {
                    usersList.innerHTML = '<p class="empty-state">No users found</p>';
                }
            } catch (error) {
                console.error('Load users error:', error);
                document.getElementById('usersList').innerHTML = '<p class="error-message">Failed to load users</p>';
            }
        }
        
        // Create user item element for the admin panel
        function createUserItem(user) {
            const userItem = document.createElement('div');
            userItem.className = 'user-item';
            userItem.dataset.userId = user.id;
            
            // Create user info
            const userInfo = document.createElement('div');
            userInfo.className = 'user-info';
            userInfo.innerHTML = `
                <div class="user-name">${user.fullName || user.username}</div>
                <div class="user-details">
                    <div class="user-username">Username: ${user.username}</div>
                    ${user.email ? `<div class="user-email">Email: ${user.email}</div>` : ''}
                    <div class="user-role">Role: ${user.role}</div>
                    <div class="user-status">Status: ${user.approved ? 'Approved' : 'Pending'}</div>
                    <div class="user-created">Registered: ${new Date(user.created).toLocaleDateString()}</div>
                </div>
            `;
            
            userItem.appendChild(userInfo);
            
            // Create action buttons (don't show for admin user)
            if (user.username !== 'admin') {
                const userActions = document.createElement('div');
                userActions.className = 'user-actions';
                
                if (!user.approved) {
                    const approveBtn = document.createElement('button');
                    approveBtn.className = 'approve-btn';
                    approveBtn.textContent = 'Approve';
                    approveBtn.onclick = () => updateUserApproval(user.id, true);
                    userActions.appendChild(approveBtn);
                    
                    const rejectBtn = document.createElement('button');
                    rejectBtn.className = 'revoke-btn';
                    rejectBtn.textContent = 'Reject';
                    rejectBtn.onclick = () => updateUserApproval(user.id, false);
                    userActions.appendChild(rejectBtn);
                } else {
                    const revokeBtn = document.createElement('button');
                    revokeBtn.className = 'revoke-btn';
                    revokeBtn.textContent = 'Revoke Access';
                    revokeBtn.onclick = () => updateUserApproval(user.id, false);
                    userActions.appendChild(revokeBtn);
                    
                    // Add "Make Admin" button for non-admin users who are approved
                    if (user.role !== 'admin') {
                        const makeAdminBtn = document.createElement('button');
                        makeAdminBtn.className = 'admin-btn';
                        makeAdminBtn.textContent = 'Make Admin';
                        makeAdminBtn.onclick = () => updateUserRole(user.id, 'admin');
                        userActions.appendChild(makeAdminBtn);
                    } else {
                        // For admin users, add a "Revoke Admin" button
                        const revokeAdminBtn = document.createElement('button');
                        revokeAdminBtn.className = 'revoke-admin-btn';
                        revokeAdminBtn.textContent = 'Revoke Admin';
                        revokeAdminBtn.onclick = () => updateUserRole(user.id, 'user');
                        userActions.appendChild(revokeAdminBtn);
                    }
                }
                
                // Add delete button for all non-admin users
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.textContent = 'Delete User';
                deleteBtn.onclick = () => deleteUser(user.id, user.username);
                userActions.appendChild(deleteBtn);
                
                userItem.appendChild(userActions);
            }
            
            return userItem;
        }
        
        // Update user approval status
        async function updateUserApproval(userId, approved) {
            try {
                const response = await fetch(`${CONFIG.baseUrl}/api/users/${userId}/approval`, {
                    method: 'PUT',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ approved })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification(`User ${approved ? 'approved' : 'access revoked'} successfully`, 'success');
                    loadUsers(); // Reload user list
                } else {
                    showNotification(data.error || `Failed to ${approved ? 'approve' : 'revoke'} user`, 'error');
                }
            } catch (error) {
                console.error('Update user approval error:', error);
                showNotification(`Failed to ${approved ? 'approve' : 'revoke'} user`, 'error');
            }
        }
        
        // Update user role
        async function updateUserRole(userId, role) {
            try {
                const response = await fetch(`${CONFIG.baseUrl}/api/users/${userId}/role`, {
                    method: 'PUT',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ role })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification(`User role updated to ${role} successfully`, 'success');
                    loadUsers(); // Reload user list
                } else {
                    showNotification(data.error || `Failed to update user role`, 'error');
                }
            } catch (error) {
                console.error('Update user role error:', error);
                showNotification(`Failed to update user role`, 'error');
            }
        }

        // Delete user
        async function deleteUser(userId, username) {
            showConfirmDialog(`Are you sure you want to delete user "${username}"?`, async () => {
                try {
                    const response = await fetch(`${CONFIG.baseUrl}/api/users/${userId}`, {
                        method: 'DELETE',
                        credentials: 'include',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        showNotification('User deleted successfully', 'success');
                        loadUsers(); // Reload user list
                    } else {
                        showNotification(data.error || 'Failed to delete user', 'error');
                    }
                } catch (error) {
                    console.error('Delete user error:', error);
                    showNotification('Failed to delete user', 'error');
                }
            }, 'user');
        }

        // Function to update UI elements based on user permissions
        async function updateUserPermissions() {
            try {
                const response = await fetch(`${CONFIG.baseUrl}/api/check-admin`, {
                    credentials: 'include'
                });
                
                const data = await response.json();
                const isAdmin = data.isAdmin;
                localStorage.setItem('userRole', isAdmin ? 'admin' : 'user');
                
                // Proje oluşturma butonunu göster/gizle
                const createProjectButton = document.querySelector('.create-project');
                if (createProjectButton) {
                    createProjectButton.style.display = isAdmin ? 'block' : 'none';
                }
                
                // Tüm sayfalardaki silme ve yükleme butonlarını güncelleyelim
                // Bu fonksiyon showAllApps içindeki app-card oluşturulduğunda çalışacak
                updateActionButtons();
            } catch (error) {
                console.error('Failed to update user permissions:', error);
            }
        }
        
        // Function to update delete and upload buttons
        function updateActionButtons() {
            const isAdmin = localStorage.getItem('userRole') === 'admin';
            
            // Uygulama kart eylemlerini güncelle
            document.querySelectorAll('.app-actions').forEach(actionContainer => {
                const uploadBtn = actionContainer.querySelector('button:first-child');
                const deleteBtn = actionContainer.querySelector('button:last-child');
                
                if (uploadBtn) uploadBtn.style.display = isAdmin ? 'flex' : 'none';
                if (deleteBtn) deleteBtn.style.display = isAdmin ? 'flex' : 'none';
            });
            
            // Tüm version-actions içindeki silme butonlarını güncelle
            document.querySelectorAll('.version-actions').forEach(versionActions => {
                const downloadBtn = versionActions.querySelector('button:first-child');
                const deleteBtn = versionActions.querySelector('button:last-child');
                
                // İndirme butonunu herkes görebilir
                if (downloadBtn) downloadBtn.style.display = 'flex';
                
                // Silme butonunu sadece adminler görebilir
                if (deleteBtn) deleteBtn.style.display = isAdmin ? 'flex' : 'none';
            });
        }

        // Add Intersection Observer for lazy loading
        function setupLazyLoading() {
            // ... existing code ...
        }

        // This function will be called when app-cards are created in showAllApps
        updateActionButtons();

        // ... existing code ...

        // Update all delete buttons inside version-actions
        document.querySelectorAll('.version-actions').forEach(versionActions => {
            // ... existing code ...
        });

        // ... existing code ...

        // Add touch events handler for mobile
        document.addEventListener('touchstart', function() {
            // This empty handler enables :active CSS states on iOS
        }, false);
    </script>
</body>
</html>